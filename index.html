<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinFlow â€” Your Financial Future</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0b0f;
  --surface: #12141a;
  --surface2: #1a1d26;
  --surface3: #22263a;
  --border: rgba(255,255,255,0.07);
  --text: #eef0f8;
  --muted: #6b7299;
  --accent: #5c7cff;
  --accent2: #a78bfa;
  --green: #22d47e;
  --red: #ff5b6b;
  --orange: #ff9f43;
  --yellow: #ffd43b;
  --card-r: 16px;
  --font: 'Syne', sans-serif;
  --mono: 'DM Mono', monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px;}

/* Layout */
.app{display:flex;min-height:100vh;}
.sidebar{width:220px;background:var(â€“surface);border-right:1px solid var(â€“border);display:flex;flex-direction:column;padding:24px 0;position:fixed;height:100vh;z-index:100;transition:.3s;}
.main{margin-left:220px;flex:1;padding:28px 32px;max-width:1400px;}
.logo{padding:0 20px 24px;font-size:20px;font-weight:800;letter-spacing:-0.5px;border-bottom:1px solid var(â€“border);}
.logo span{color:var(â€“accent);}
.nav-section{padding:20px 12px 8px;font-size:10px;font-weight:700;letter-spacing:2px;color:var(â€“muted);text-transform:uppercase;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;font-size:13px;font-weight:600;color:var(â€“muted);transition:.2s;border-radius:0;position:relative;letter-spacing:.3px;}
.nav-item:hover{color:var(â€“text);background:var(â€“surface2);}
.nav-item.active{color:var(â€“accent);background:rgba(92,124,255,0.1);}
.nav-item.active::before{content:â€™â€™;position:absolute;left:0;top:0;bottom:0;width:3px;background:var(â€“accent);border-radius:0 3px 3px 0;}
.nav-icon{font-size:16px;width:20px;text-align:center;}
.sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid var(â€“border);display:flex;gap:8px;}
.sidebar-footer button{flex:1;padding:8px;background:var(â€“surface3);border:none;border-radius:8px;color:var(â€“text);font-family:var(â€“font);font-size:11px;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:.2s;}
.sidebar-footer button:hover{background:var(â€“accent);color:#fff;}

/* Pages */
.page{display:none;}
.page.active{display:block;}

/* Header */
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px;}
.page-title{font-size:26px;font-weight:800;letter-spacing:-0.5px;}
.page-subtitle{font-size:13px;color:var(â€“muted);margin-top:4px;}
.header-actions{display:flex;gap:8px;}

/* Cards */
.card{background:var(â€“surface);border:1px solid var(â€“border);border-radius:var(â€“card-r);padding:20px;}
.card-sm{padding:16px;}
.card-title{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(â€“muted);text-transform:uppercase;margin-bottom:12px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
.col-span-2{grid-column:span 2;}
.col-span-3{grid-column:span 3;}

/* KPI Cards */
.kpi{background:var(â€“surface);border:1px solid var(â€“border);border-radius:var(â€“card-r);padding:20px;position:relative;overflow:hidden;transition:.2s;}
.kpi::after{content:â€™â€™;position:absolute;bottom:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.08;}
.kpi.green::after{background:var(â€“green);}
.kpi.red::after{background:var(â€“red);}
.kpi.blue::after{background:var(â€“accent);}
.kpi.purple::after{background:var(â€“accent2);}
.kpi-label{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(â€“muted);text-transform:uppercase;margin-bottom:8px;}
.kpi-value{font-family:var(â€“mono);font-size:26px;font-weight:500;letter-spacing:-1px;line-height:1;}
.kpi-value.green{color:var(â€“green);}
.kpi-value.red{color:var(â€“red);}
.kpi-value.blue{color:var(â€“accent);}
.kpi-value.orange{color:var(â€“orange);}
.kpi-sub{font-size:11px;color:var(â€“muted);margin-top:6px;font-family:var(â€“mono);}

/* Buttons */
.btn{padding:9px 18px;border-radius:9px;border:none;font-family:var(â€“font);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:.2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(â€“accent);color:#fff;}
.btn-primary:hover{background:#4a6bef;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(â€“muted);border:1px solid var(â€“border);}
.btn-ghost:hover{color:var(â€“text);border-color:rgba(255,255,255,.2);}
.btn-danger{background:rgba(255,91,107,.15);color:var(â€“red);border:1px solid rgba(255,91,107,.2);}
.btn-danger:hover{background:var(â€“red);color:#fff;}
.btn-success{background:rgba(34,212,126,.15);color:var(â€“green);border:1px solid rgba(34,212,126,.2);}
.btn-success:hover{background:var(â€“green);color:#000;}
.btn-sm{padding:6px 12px;font-size:11px;}
.btn-icon{padding:7px;border-radius:8px;background:var(â€“surface3);border:1px solid var(â€“border);color:var(â€“muted);cursor:pointer;transition:.2s;font-size:14px;}
.btn-icon:hover{color:var(â€“text);border-color:rgba(255,255,255,.2);}

/* Forms */
.form-group{margin-bottom:14px;}
.form-label{font-size:11px;font-weight:700;letter-spacing:1px;color:var(â€“muted);text-transform:uppercase;margin-bottom:6px;display:block;}
.form-input{width:100%;padding:10px 14px;background:var(â€“surface2);border:1px solid var(â€“border);border-radius:10px;color:var(â€“text);font-family:var(â€“mono);font-size:13px;transition:.2s;outline:none;}
.form-input:focus{border-color:var(â€“accent);background:var(â€“surface3);}
.form-input::placeholder{color:var(â€“muted);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
select.form-input{cursor:pointer;}
select.form-input option{background:var(â€“surface2);}

/* Toggle */
.toggle-wrap{display:flex;align-items:center;gap:10px;}
.toggle{position:relative;width:40px;height:22px;cursor:pointer;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(â€“surface3);border-radius:99px;transition:.2s;}
.toggle-slider::before{content:â€™â€™;position:absolute;width:16px;height:16px;left:3px;top:3px;background:var(â€“muted);border-radius:50%;transition:.2s;}
.toggle input:checked + .toggle-slider{background:var(â€“accent);}
.toggle input:checked + .toggle-slider::before{transform:translateX(18px);background:#fff;}
.toggle-label{font-size:12px;color:var(â€“muted);}

/* Debt Cards */
.debt-list{display:flex;flex-direction:column;gap:10px;}
.debt-item{background:var(â€“surface2);border:1px solid var(â€“border);border-radius:12px;padding:16px;transition:.2s;position:relative;}
.debt-item:hover{border-color:rgba(255,255,255,.12);}
.debt-item.excluded{opacity:.45;}
.debt-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.debt-name{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
.debt-badge{font-size:9px;font-weight:700;letter-spacing:1px;padding:3px 7px;border-radius:99px;text-transform:uppercase;}
.badge-cc{background:rgba(92,124,255,.2);color:var(â€“accent);}
.badge-loan{background:rgba(167,139,250,.2);color:var(â€“accent2);}
.badge-auto{background:rgba(255,159,67,.2);color:var(â€“orange);}
.badge-student{background:rgba(34,212,126,.2);color:var(â€“green);}
.debt-balance{font-family:var(â€“mono);font-size:20px;font-weight:500;color:var(â€“red);}
.debt-meta{display:flex;gap:16px;flex-wrap:wrap;}
.debt-meta-item{font-size:11px;color:var(â€“muted);font-family:var(â€“mono);}
.debt-meta-item span{color:var(â€“text);font-weight:500;}
.debt-progress{margin-top:12px;}
.progress-bar{height:4px;background:var(â€“surface3);border-radius:99px;overflow:hidden;}
.progress-fill{height:100%;border-radius:99px;transition:width .5s;}
.debt-actions{display:flex;gap:6px;margin-top:12px;}

/* Modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-backdrop.open{display:flex;}
.modal{background:var(â€“surface);border:1px solid var(â€“border);border-radius:20px;padding:28px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto;animation:modalIn .2s ease;}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px);}to{opacity:1;transform:none;}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-size:18px;font-weight:800;}

/* Chart Container */
.chart-wrap{position:relative;height:280px;}
.chart-wrap-lg{position:relative;height:360px;}

/* Allocation Sliders */
.alloc-item{margin-bottom:16px;}
.alloc-header{display:flex;justify-content:space-between;margin-bottom:6px;}
.alloc-name{font-size:12px;font-weight:700;}
.alloc-amount{font-family:var(â€“mono);font-size:12px;color:var(â€“accent);}
.range-input{width:100%;-webkit-appearance:none;appearance:none;height:6px;border-radius:99px;background:var(â€“surface3);outline:none;cursor:pointer;}
.range-input::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(â€“accent);cursor:pointer;box-shadow:0 0 0 3px rgba(92,124,255,.2);}
.range-input::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(â€“accent);cursor:pointer;border:none;}

/* Cash Flow */
.cf-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(â€“border);}
.cf-row:last-child{border-bottom:none;}
.cf-label{font-size:13px;font-weight:600;}
.cf-amount{font-family:var(â€“mono);font-size:13px;}
.cf-amount.income{color:var(â€“green);}
.cf-amount.expense{color:var(â€“red);}
.cf-amount.neutral{color:var(â€“text);}

/* Tabs */
.tabs{display:flex;gap:4px;background:var(â€“surface2);border-radius:10px;padding:4px;margin-bottom:20px;}
.tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:.2s;color:var(â€“muted);border:none;background:none;font-family:var(â€“font);}
.tab.active{background:var(â€“surface);color:var(â€“text);box-shadow:0 2px 8px rgba(0,0,0,.3);}

/* Payoff timeline */
.payoff-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(â€“surface2);border-radius:10px;margin-bottom:8px;}
.payoff-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.payoff-info{flex:1;}
.payoff-name{font-size:13px;font-weight:700;}
.payoff-date{font-size:11px;color:var(â€“muted);font-family:var(â€“mono);}
.payoff-interest{font-family:var(â€“mono);font-size:12px;color:var(â€“orange);}

/* Goals */
.goal-item{background:var(â€“surface2);border:1px solid var(â€“border);border-radius:12px;padding:16px;margin-bottom:10px;}
.goal-header{display:flex;justify-content:space-between;margin-bottom:10px;}
.goal-name{font-size:14px;font-weight:700;}
.goal-amount{font-family:var(â€“mono);font-size:13px;color:var(â€“green);}
.goal-progress-text{font-size:11px;color:var(â€“muted);margin-top:6px;font-family:var(â€“mono);}

/* Tags */
.tag{display:inline-flex;align-items:center;padding:3px 8px;border-radius:99px;font-size:10px;font-weight:700;letter-spacing:.5px;}
.tag-surplus{background:rgba(34,212,126,.15);color:var(â€“green);}
.tag-deficit{background:rgba(255,91,107,.15);color:var(â€“red);}

/* Net Surplus Bar */
.surplus-bar{display:flex;height:8px;border-radius:99px;overflow:hidden;margin:8px 0;}

/* Forecast budget bar */
.fc-budget-bar{display:flex;height:20px;border-radius:10px;overflow:hidden;margin:8px 0;}
.fc-budget-segment{height:100%;transition:.3s;}
.fc-budget-legend{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;}
.fc-budget-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px;flex-shrink:0;}
.fc-legend-item{display:flex;align-items:center;font-size:11px;color:#6b7299;font-family:'DM Mono',monospace;}
.fc-legend-item span{color:#eef0f8;}

/* Forecast payoff list */
.fc-debt-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.fc-debt-row:last-child{border-bottom:none;}
.fc-debt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.fc-debt-info{flex:1;}
.fc-debt-name{font-size:13px;font-weight:700;}
.fc-debt-date{font-size:11px;color:#6b7299;font-family:'DM Mono',monospace;margin-top:2px;}
.fc-debt-amount{text-align:right;font-family:'DM Mono',monospace;font-size:13px;}

/* Forecast table */
.fc-table-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:8px 4px;border-bottom:1px solid rgba(255,255,255,0.04);font-family:'DM Mono',monospace;font-size:11px;}
.fc-table-row:first-child{border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:2px;padding-bottom:10px;}
.fc-table-header{font-size:10px;font-weight:700;letter-spacing:1px;color:#6b7299;text-transform:uppercase;}

/* Forecast planner table */
.fc-planner-header{display:grid;grid-template-columns:2fr 1.2fr 1.6fr 1.2fr 1.2fr;gap:12px;padding:8px 4px 10px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:2px;font-size:10px;font-weight:700;letter-spacing:1px;color:#6b7299;text-transform:uppercase;}
.fc-planner-row{display:grid;grid-template-columns:2fr 1.2fr 1.6fr 1.2fr 1.2fr;gap:12px;align-items:center;padding:14px 4px;border-bottom:1px solid rgba(255,255,255,0.04);}
.fc-planner-row:last-child{border-bottom:none;}
.fc-goal-row{grid-template-columns:2fr 1.5fr 1.6fr 1.2fr;}
.fc-savings-header{grid-template-columns:2fr 1.5fr 1.6fr 1.2fr;}
.fc-planner-name{display:flex;align-items:center;gap:10px;}
.fc-input-wrap{display:flex;align-items:center;gap:6px;background:#0a0b0f;border:1px solid rgba(92,124,255,0.35);border-radius:10px;padding:8px 12px;transition:.2s;}
.fc-input-wrap:focus-within{border-color:#5c7cff;box-shadow:0 0 0 3px rgba(92,124,255,0.1);}
.fc-input-label{font-size:12px;color:#6b7299;font-family:'DM Mono',monospace;flex-shrink:0;}
.fc-payment-input{background:transparent;border:none;outline:none;color:#eef0f8;font-family:'DM Mono',monospace;font-size:16px;font-weight:500;width:90px;text-align:right;}
.fc-payment-input::-webkit-inner-spin-button,.fc-payment-input::-webkit-outer-spin-button{-webkit-appearance:none;}
.fc-payment-input::placeholder{color:#3a3d50;}
.fc-warn{font-size:10px;color:#ff5b6b;margin-top:3px;font-family:'DM Mono',monospace;min-height:14px;}

/* Forecast: debt/expense container wrapper */
.fc-debt-container,.fc-expense-container{border-bottom:1px solid rgba(255,255,255,0.05);}
.fc-debt-container:last-child,.fc-expense-container:last-child{border-bottom:none;}
.fc-expand-row{display:flex;justify-content:flex-end;padding:0 4px 10px;}
.fc-expand-btn{display:flex;align-items:center;gap:5px;font-size:11px;color:#5c7cff;background:rgba(92,124,255,0.1);border:1px solid rgba(92,124,255,0.25);border-radius:8px;padding:5px 11px;cursor:pointer;font-family:'DM Mono',monospace;font-weight:700;transition:.2s;white-space:nowrap;}
.fc-expand-btn:hover{background:rgba(92,124,255,0.2);}

/* Monthly planning grid */
.fc-monthly-grid{display:none;background:#080910;border-radius:12px;padding:14px 14px 10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.08);}
.fc-monthly-grid.open{display:block;}
.fc-months-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.fc-month-table{border-collapse:collapse;min-width:100%;}
.fc-month-table th{font-size:10px;font-weight:700;color:#6b7299;text-transform:uppercase;letter-spacing:.5px;padding:6px 8px;text-align:center;white-space:nowrap;min-width:72px;border-bottom:1px solid rgba(255,255,255,0.07);}
.fc-month-table th:first-child{text-align:left;min-width:90px;position:sticky;left:0;background:#080910;z-index:1;}
.fc-month-table td{padding:5px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03);}
.fc-month-table td:first-child{text-align:left;font-size:11px;color:#6b7299;white-space:nowrap;padding-right:12px;position:sticky;left:0;background:#080910;z-index:1;}
.fc-month-table tr:last-child td{border-bottom:none;}
.fc-month-input{background:#12141a;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 6px;color:#eef0f8;font-family:'DM Mono',monospace;font-size:12px;width:68px;text-align:center;outline:none;transition:.2s;}
.fc-month-input:focus{border-color:#5c7cff;box-shadow:0 0 0 2px rgba(92,124,255,0.12);}
.fc-month-input.modified{border-color:rgba(92,124,255,0.55);background:rgba(92,124,255,0.07);}
.fc-month-input::-webkit-inner-spin-button,.fc-month-input::-webkit-outer-spin-button{-webkit-appearance:none;}
.fc-month-stat{font-size:11px;font-family:'DM Mono',monospace;color:#6b7299;}
.fc-grid-actions{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap;}
.fc-grid-action-btn{font-size:10px;color:#5c7cff;background:none;border:none;cursor:pointer;text-decoration:underline;padding:0;font-family:'DM Mono',monospace;}
.fc-grid-action-btn.muted{color:#6b7299;}

/* â”€â”€ Master Forecast Spreadsheet Table â”€â”€ */
.fc-master-table-wrap{overflow-x:auto;overflow-y:auto;max-height:68vh;}
.fc-master-table{border-collapse:collapse;width:max-content;min-width:100%;font-size:12px;}
.fc-master-table th,.fc-master-table td{padding:5px 8px;white-space:nowrap;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
.fc-tbl-label{position:sticky;left:0;z-index:5;background:#12141a;min-width:172px;max-width:200px;border-right:1px solid rgba(255,255,255,0.07);font-size:12px;}
.fc-tbl-th{background:#1a1c24 !important;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:#6b7299;position:sticky;top:0;z-index:10;padding:8px 8px;text-align:center;}
.fc-tbl-label.fc-tbl-th{z-index:15;text-align:left;left:0;}
.fc-tbl-total-col.fc-tbl-th{z-index:10;right:0;}
.fc-tbl-month{text-align:center;min-width:90px;}
.fc-tbl-total-col{min-width:90px;text-align:right;border-left:1px solid rgba(255,255,255,0.08);background:#0a0b0f;font-weight:700;font-family:'DM Mono',monospace;position:sticky;right:0;}
.fc-tbl-default-col{min-width:96px;text-align:right;border-right:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.025);position:sticky;left:180px;}
.fc-tbl-default-col.fc-tbl-th{font-size:10px;letter-spacing:.5px;text-transform:uppercase;color:#6b7299;}
.fc-tbl-cell{text-align:right;padding:3px 6px;}
.fc-tbl-calc{text-align:right;font-family:'DM Mono',monospace;font-size:11px;color:#6b7299;padding:5px 8px;}
/* Section separator rows */
.fc-tbl-section .fc-tbl-label{background:#0e1016;font-size:10px;font-weight:800;letter-spacing:.1em;text-transform:uppercase;color:#6b7299;padding:5px 10px;border-top:1px solid rgba(255,255,255,0.07);}
.fc-tbl-section td.fc-tbl-section-fill{background:#0e1016;border-top:1px solid rgba(255,255,255,0.07);}
/* Row colors */
.fc-tbl-row-income .fc-tbl-label{color:#22d47e;}
.fc-tbl-row-income .fc-tbl-calc,.fc-tbl-row-income .fc-tbl-total-col{color:#22d47e;}
.fc-tbl-row-expense .fc-tbl-label{color:#ff5b6b;}
.fc-tbl-row-debt .fc-tbl-label{color:#ff9f43;}
.fc-tbl-row-debt-bal .fc-tbl-label,.fc-tbl-row-debt-int .fc-tbl-label{color:rgba(255,159,67,0.45);font-size:11px;padding-left:18px;}
.fc-tbl-row-savings .fc-tbl-label{color:#38bdf8;}
.fc-tbl-row-total-out td{border-top:2px solid rgba(255,255,255,0.09);font-weight:700;}
.fc-tbl-row-total-out .fc-tbl-label{color:#ff5b6b;font-weight:700;}
.fc-tbl-row-surplus .fc-tbl-label{color:#eef0f8;font-weight:700;}
.fc-tbl-row-cumul .fc-tbl-label{color:#5c7cff;font-weight:700;}
.fc-tbl-row-cum-inc .fc-tbl-label{color:#22d47e;}
.fc-tbl-row-cum-exp .fc-tbl-label{color:#ff5b6b;}
.fc-tbl-row-debt-remaining .fc-tbl-label{color:#ff9f43;font-weight:700;}
/* Editable cell inputs */
.fc-cell-input{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,0.09);color:#eef0f8;font-family:'DM Mono',monospace;font-size:11px;width:78px;text-align:right;padding:1px 2px;outline:none;transition:.15s;}
.fc-cell-input:focus{border-bottom-color:#5c7cff;background:rgba(92,124,255,0.07);border-radius:3px 3px 0 0;}
.fc-cell-input.modified{color:#5c7cff;border-bottom-color:rgba(92,124,255,0.4);}
.fc-cell-input::placeholder{color:rgba(238,240,248,0.22);font-size:10px;}
.fc-cell-input::-webkit-inner-spin-button,.fc-cell-input::-webkit-outer-spin-button{-webkit-appearance:none;}

/* Expense planner */
.fc-expense-planner-header{display:grid;grid-template-columns:2fr 1.2fr 1.6fr 1.2fr;gap:12px;padding:8px 4px 10px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:2px;font-size:10px;font-weight:700;letter-spacing:1px;color:#6b7299;text-transform:uppercase;}
.fc-expense-row{display:grid;grid-template-columns:2fr 1.2fr 1.6fr 1.2fr;gap:12px;align-items:center;padding:14px 4px;border-bottom:none;}

/* Mobile: planner rows stack to cards */
@media(max-width:768px){
.fc-planner-header{display:none;}
.fc-savings-header{display:none;}
.fc-planner-row{display:block;padding:14px;margin-bottom:8px;background:#0a0b0f;border-radius:12px;border:1px solid rgba(255,255,255,0.07);}
.fc-planner-row:last-child{border-bottom:1px solid rgba(255,255,255,0.07);}
.fc-planner-name{margin-bottom:10px;}
.fc-mobile-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
.fc-mobile-field{display:flex;flex-direction:column;gap:4px;}
.fc-mobile-label{font-size:10px;font-weight:700;letter-spacing:1px;color:#6b7299;text-transform:uppercase;}
.fc-mobile-val{font-size:13px;font-weight:700;}
.fc-input-wrap{max-width:100%;}
.fc-payment-input{width:100%;min-width:60px;}
}

/* Mobile nav */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#000000;border-top:1px solid rgba(255,255,255,0.12);z-index:100;padding:8px 0 env(safe-area-inset-bottom);box-shadow:0 -4px 20px rgba(0,0,0,0.6);}
.mobile-nav-items{display:flex;justify-content:space-around;}
.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 8px;cursor:pointer;color:#6b7299;font-size:9px;font-weight:700;letter-spacing:.5px;transition:.2s;min-width:48px;}
.mobile-nav-item.active{color:#5c7cff;}
.mobile-nav-icon{font-size:16px;}
.hamburger{display:none;cursor:pointer;font-size:20px;padding:8px;}

/* Notification */
.toast{position:fixed;bottom:80px;right:20px;background:var(â€“surface2);border:1px solid var(â€“border);border-radius:12px;padding:12px 18px;font-size:13px;z-index:2000;transform:translateX(200px);opacity:0;transition:.3s;max-width:280px;}
.toast.show{transform:none;opacity:1;}
.toast.success{border-color:rgba(34,212,126,.3);color:var(â€“green);}
.toast.error{border-color:rgba(255,91,107,.3);color:var(â€“red);}

/* Empty state */
.empty{text-align:center;padding:40px 20px;color:var(â€“muted);}
.empty-icon{font-size:36px;margin-bottom:12px;}
.empty-text{font-size:13px;}

/* Section divider */
.section-gap{margin-top:24px;}

@media(max-width:900px){
.grid-4{grid-template-columns:1fr 1fr;}
.grid-3{grid-template-columns:1fr 1fr;}
}
@media(max-width:768px){
.sidebar{transform:translateX(-220px);}
.sidebar.open{transform:none;box-shadow:0 0 40px rgba(0,0,0,.8);}
.main{margin-left:0;padding:20px 16px 100px;}
.mobile-nav{display:block;}
.hamburger{display:block;}
.grid-4{grid-template-columns:1fr 1fr;}
.grid-3{grid-template-columns:1fr 1fr;}
.grid-2{grid-template-columns:1fr;}
.col-span-2{grid-column:span 1;}
.form-row{grid-template-columns:1fr;}
.form-row-3{grid-template-columns:1fr 1fr;}
.page-header{margin-top:12px;}
}
@media(max-width:480px){
.grid-4{grid-template-columns:1fr 1fr;}
.grid-3{grid-template-columns:1fr;}
.kpi-value{font-size:20px;}
}
</style>

</head>
<body>

<!-- Toast -->

<div class="toast" id="toast"></div>

<!-- Sidebar -->

<nav class="sidebar" id="sidebar">
  <div class="logo">Fin<span>Flow</span></div>
  <div class="nav-section">Overview</div>
  <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">âš¡</span> Dashboard</div>
  <div class="nav-item" onclick="showPage('cashflow')"><span class="nav-icon">ðŸ’¸</span> Cash Flow</div>
  <div class="nav-section">Debt</div>
  <div class="nav-item" onclick="showPage('debts')"><span class="nav-icon">ðŸ’³</span> My Accounts</div>
  <div class="nav-item" onclick="showPage('payoff')"><span class="nav-icon">ðŸ“ˆ</span> Payoff Planner</div>
  <div class="nav-section">Future</div>
  <div class="nav-item" onclick="showPage('goals')"><span class="nav-icon">ðŸŽ¯</span> Savings Goals</div>
  <div class="nav-item" onclick="showPage('forecast')"><span class="nav-icon">ðŸ”®</span> Forecast</div>
  <div class="sidebar-footer">
    <button onclick="exportData()">â¬‡ Export</button>
    <button onclick="document.getElementById('importFile').click()">â¬† Import</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</nav>

<div class="main" id="mainContent">
  <!-- Mobile top bar -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;" id="mobileBar">
    <div class="hamburger" onclick="toggleSidebar()">â˜°</div>
    <div style="font-size:16px;font-weight:800;">Fin<span style="color:var(--accent)">Flow</span></div>
    <div style="width:36px;"></div>
  </div>

  <!-- DASHBOARD -->

  <div class="page active" id="page-dashboard">
    <div class="page-header">
      <div>
        <div class="page-title">Dashboard</div>
        <div class="page-subtitle" id="dashSubtitle">Loading your financial snapshot...</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="showPage('cashflow')">+ Update Cash Flow</button>
      </div>
    </div>

```
<div class="grid-4" style="margin-bottom:16px;">
  <div class="kpi green">
    <div class="kpi-label">Monthly Income</div>
    <div class="kpi-value green" id="kpiIncome">$0</div>
    <div class="kpi-sub">Expected this month</div>
  </div>
  <div class="kpi red">
    <div class="kpi-label">Monthly Expenses</div>
    <div class="kpi-value red" id="kpiExpenses">$0</div>
    <div class="kpi-sub">Fixed + variable</div>
  </div>
  <div class="kpi blue">
    <div class="kpi-label">Net Surplus</div>
    <div class="kpi-value" id="kpiSurplus">$0</div>
    <div class="kpi-sub" id="kpiSurplusSub">Available after expenses</div>
  </div>
  <div class="kpi red">
    <div class="kpi-label">Total Debt</div>
    <div class="kpi-value orange" id="kpiDebt">$0</div>
    <div class="kpi-sub" id="kpiDebtSub">Across all accounts</div>
  </div>
</div>

<div class="card" style="margin-bottom:16px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div class="card-title" style="margin-bottom:0;">Monthly Budget Breakdown</div>
    <div id="dashBudgetTag" style="font-size:11px;font-weight:700;font-family:'DM Mono',monospace;padding:4px 12px;border-radius:99px;"></div>
  </div>
  <div id="dashBudgetBar" style="margin:0 0 10px;"></div>
  <div class="fc-budget-legend" id="dashBudgetLegend"></div>
</div>

<div class="card" style="margin-bottom:16px;">
  <div style="text-align:center;margin-bottom:4px;">
    <div id="netSurplusLabel" style="font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#6b7299;">Net Surplus</div>
    <div id="netSurplusAmount" style="font-family:'DM Mono',monospace;font-size:32px;font-weight:500;letter-spacing:-1px;margin:4px 0;">$0</div>
    <div id="netSurplusDesc" style="font-size:11px;color:#6b7299;font-family:'DM Mono',monospace;margin-bottom:12px;">after all expenses &amp; debt payments</div>
  </div>
  <div style="height:200px;"><canvas id="netSurplusChart"></canvas></div>
</div>

<div class="grid-2" style="margin-bottom:16px;">
  <div class="card">
    <div class="card-title">Income vs Expenses</div>
    <div class="chart-wrap"><canvas id="incomeExpenseChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Debt Breakdown</div>
    <div class="chart-wrap"><canvas id="debtPieChart"></canvas></div>
  </div>
</div>

<div class="grid-2">
  <div class="card">
    <div class="card-title">Surplus Allocation This Month</div>
    <div id="surplusAllocationList">
      <div class="empty"><div class="empty-icon">ðŸ“Š</div><div class="empty-text">Set up your cash flow to see allocation</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Quick Account Summary</div>
    <div id="quickAccountSummary"></div>
  </div>
</div>
```

  </div>

  <!-- CASH FLOW -->

  <div class="page" id="page-cashflow">
    <div class="page-header">
      <div>
        <div class="page-title">Cash Flow</div>
        <div class="page-subtitle">Track your monthly income and expenses</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-success" onclick="openModal('incomModal')">+ Add Income</button>
        <button class="btn btn-danger" onclick="openModal('expenseModal')">+ Add Expense</button>
      </div>
    </div>

```
<div class="grid-3" style="margin-bottom:20px;">
  <div class="kpi green">
    <div class="kpi-label">Total Income</div>
    <div class="kpi-value green" id="cfIncome">$0</div>
  </div>
  <div class="kpi red">
    <div class="kpi-label">Total Expenses</div>
    <div class="kpi-value red" id="cfExpenses">$0</div>
  </div>
  <div class="kpi blue">
    <div class="kpi-label">Net Surplus</div>
    <div class="kpi-value" id="cfSurplus">$0</div>
  </div>
</div>

<div class="grid-2">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div class="card-title" style="margin:0;">Income Sources</div>
      <button class="btn btn-sm btn-success" onclick="openModal('incomeModal')">+ Add</button>
    </div>
    <div id="incomeList"><div class="empty"><div class="empty-icon">ðŸ’°</div><div class="empty-text">No income added yet</div></div></div>
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div class="card-title" style="margin:0;">Expenses</div>
      <button class="btn btn-sm btn-danger" onclick="openModal('expenseModal')">+ Add</button>
    </div>
    <div id="expenseList"><div class="empty"><div class="empty-icon">ðŸ’³</div><div class="empty-text">No expenses added yet</div></div></div>
  </div>
</div>

<div class="card section-gap">
  <div class="card-title">Monthly Cash Flow Trend</div>
  <div class="chart-wrap"><canvas id="cashflowTrendChart"></canvas></div>
</div>
```

  </div>

  <!-- MY ACCOUNTS / DEBTS -->

  <div class="page" id="page-debts">
    <div class="page-header">
      <div>
        <div class="page-title">My Accounts</div>
        <div class="page-subtitle">All your debts and loans in one place</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openModal('addDebtModal')">+ Add Account</button>
      </div>
    </div>

```
<div class="grid-3" style="margin-bottom:20px;">
  <div class="kpi red">
    <div class="kpi-label">Total Debt (Included)</div>
    <div class="kpi-value red" id="debtTotalIncluded">$0</div>
  </div>
  <div class="kpi orange">
    <div class="kpi-label">Monthly Interest Cost</div>
    <div class="kpi-value orange" id="debtMonthlyInterest">$0</div>
  </div>
  <div class="kpi blue">
    <div class="kpi-label">Min. Monthly Payments</div>
    <div class="kpi-value blue" id="debtMinPayments">$0</div>
  </div>
</div>

<div class="card">
  <div class="tabs">
    <button class="tab active" onclick="filterDebts('all', this)">All Accounts</button>
    <button class="tab" onclick="filterDebts('credit', this)">Credit Cards</button>
    <button class="tab" onclick="filterDebts('loan', this)">Loans</button>
    <button class="tab" onclick="filterDebts('auto', this)">Auto</button>
    <button class="tab" onclick="filterDebts('student', this)">Student</button>
  </div>
  <div class="debt-list" id="debtList"></div>
</div>
```

  </div>

  <!-- PAYOFF PLANNER -->

  <div class="page" id="page-payoff">
    <div class="page-header">
      <div>
        <div class="page-title">Payoff Planner</div>
        <div class="page-subtitle">Project your debt-free date with different payment strategies</div>
      </div>
    </div>

```
<div class="grid-2" style="margin-bottom:20px;">
  <div class="card">
    <div class="card-title">Strategy</div>
    <div class="form-group">
      <label class="form-label">Payoff Method</label>
      <select class="form-input" id="payoffStrategy" onchange="recalcPayoff()">
        <option value="avalanche">Avalanche (Highest APR First)</option>
        <option value="snowball">Snowball (Lowest Balance First)</option>
        <option value="custom">Custom Allocation</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Extra Monthly Payment Toward Debt</label>
      <input type="number" class="form-input" id="extraPayment" value="0" oninput="recalcPayoff()" placeholder="0.00">
    </div>
    <div id="customPayoffArea"></div>
    <div style="padding-top:8px;border-top:1px solid var(--border)">
      <div class="cf-row">
        <span class="cf-label">Total Available for Debt</span>
        <span class="cf-amount neutral" id="totalForDebt">$0</span>
      </div>
      <div class="cf-row">
        <span class="cf-label">Min. Payments</span>
        <span class="cf-amount expense" id="payoffMinTotal">$0</span>
      </div>
      <div class="cf-row">
        <span class="cf-label">Extra Payments</span>
        <span class="cf-amount income" id="payoffExtraTotal">$0</span>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Payoff Timeline</div>
    <div id="payoffTimeline"></div>
  </div>
</div>

<div class="card">
  <div class="card-title">Balance Projection Over Time</div>
  <div class="chart-wrap-lg"><canvas id="payoffChart"></canvas></div>
</div>

<div class="card section-gap">
  <div class="card-title">Total Interest Paid Comparison</div>
  <div class="chart-wrap"><canvas id="interestCompChart"></canvas></div>
</div>
```

  </div>

  <!-- SAVINGS GOALS -->

  <div class="page" id="page-goals">
    <div class="page-header">
      <div>
        <div class="page-title">Savings Goals</div>
        <div class="page-subtitle">Plan for what matters â€” vacations, emergency fund, and beyond</div>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openModal('addGoalModal')">+ New Goal</button>
      </div>
    </div>
    <div class="grid-3" style="margin-bottom:20px;">
      <div class="kpi green">
        <div class="kpi-label">Total Saved</div>
        <div class="kpi-value green" id="goalsTotalSaved">$0</div>
      </div>
      <div class="kpi blue">
        <div class="kpi-label">Total Goal Amount</div>
        <div class="kpi-value blue" id="goalsTotalTarget">$0</div>
      </div>
      <div class="kpi purple">
        <div class="kpi-label">Months to All Goals</div>
        <div class="kpi-value" style="color:var(--accent2)" id="goalsTotalMonths">â€”</div>
      </div>
    </div>
    <div id="goalsList"></div>
  </div>

  <!-- FORECAST -->

  <div class="page" id="page-forecast">
    <div class="page-header">
      <div>
        <div class="page-title">Forecast</div>
        <div class="page-subtitle">Type your planned payment for each account â€” see payoff dates &amp; savings update live</div>
      </div>
      <div class="header-actions">
        <button class="btn" onclick="generateSmartPlan()" style="background:linear-gradient(135deg,#5c7cff,#a78bfa);color:#fff;font-weight:700;font-size:12px;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;" title="Auto-fill payments using avalanche method (highest APR paid first)">âœ¨ Smart Plan</button>
        <button class="btn" onclick="fcClearSmartPlan()" style="background:rgba(107,114,153,0.15);color:#6b7299;font-size:12px;padding:8px 12px;border:1px solid rgba(107,114,153,0.3);border-radius:8px;cursor:pointer;" title="Reset all debt payments to minimums">Reset Plan</button>
        <select class="form-input" id="fcMonths" onchange="fcSaveMonths(this.value)" style="padding:8px 12px;font-size:12px;width:auto;">
          <option value="12">12 Months</option>
          <option value="24">24 Months</option>
          <option value="36" selected>36 Months</option>
          <option value="60">5 Years</option>
        </select>
      </div>
    </div>

    <!-- Budget bar -->
    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div class="card-title" style="margin-bottom:0;">Monthly Budget Overview</div>
        <div id="fcSurplusTag" style="font-size:11px;font-weight:700;font-family:'DM Mono',monospace;padding:4px 12px;border-radius:99px;"></div>
      </div>
      <div class="fc-budget-bar" id="fcBudgetBar" style="height:26px;border-radius:10px;margin:0 0 10px;"></div>
      <div class="fc-budget-legend" id="fcBudgetLegend"></div>
    </div>

    <!-- KPIs -->
    <div class="grid-4" style="margin-bottom:16px;">
      <div class="kpi blue">
        <div class="kpi-label">Projected Savings</div>
        <div class="kpi-value blue" id="fcKpiSavings">$0</div>
        <div class="kpi-sub" id="fcKpiSavingsSub">over forecast period</div>
      </div>
      <div class="kpi green">
        <div class="kpi-label">Debt-Free Est.</div>
        <div class="kpi-value green" id="fcKpiDebtFree">â€”</div>
        <div class="kpi-sub">at your planned payments</div>
      </div>
      <div class="kpi" id="fcKpiSurplusCard">
        <div class="kpi-label">Monthly Surplus</div>
        <div class="kpi-value" id="fcKpiSurplus">$0</div>
        <div class="kpi-sub" id="fcKpiSurplusSub">income minus all spending</div>
      </div>
      <div class="kpi purple">
        <div class="kpi-label">Interest Saved</div>
        <div class="kpi-value" style="color:#a78bfa;" id="fcKpiInterestSaved">$0</div>
        <div class="kpi-sub">vs. minimums only</div>
      </div>
    </div>

    <!-- Master Forecast Spreadsheet Table -->
    <div class="card" style="margin-bottom:16px;padding:16px;">
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
        <div>
          <div class="card-title" style="margin-bottom:2px;">Forecast Spreadsheet</div>
          <div style="font-size:11px;color:#6b7299;">Edit any cell to override the planned amount for that month. Blue = modified. Scroll right for all months. Scroll down for all rows.</div>
        </div>
      </div>
      <div id="fcMasterTableWrap" class="fc-master-table-wrap"></div>
    </div>

    <!-- Debt Paydown Progress Chart -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title">Debt Paydown Progress</div>
      <div style="font-size:11px;color:#6b7299;margin-bottom:12px;">Remaining balance per account over your forecast period. Lines drop to zero as each debt is paid off.</div>
      <div class="chart-wrap-lg"><canvas id="debtProgressChart"></canvas></div>
    </div>

    <!-- Savings & Surplus Progress Chart -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title">Savings &amp; Surplus Progress</div>
      <div style="font-size:11px;color:#6b7299;margin-bottom:12px;">Bars show monthly surplus (green = money left over, red = over budget). Line shows cumulative savings growing over time.</div>
      <div class="chart-wrap-lg"><canvas id="savingsSurplusChart"></canvas></div>
    </div>

    <!-- Monthly Cash Flow Chart -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title">Monthly Cash Flow â€” Income vs Expenses &amp; Surplus</div>
      <div style="font-size:11px;color:#6b7299;margin-bottom:12px;">Income bars go up (green). Expense + debt bars go down (red/orange). Surplus bar is green when positive, red when negative.</div>
      <div class="chart-wrap-lg"><canvas id="forecastChart"></canvas></div>
    </div>

  </div>
</div>

<!-- Mobile Nav -->

<nav class="mobile-nav">
  <div class="mobile-nav-items">
    <div class="mobile-nav-item active" onclick="showPage('dashboard')"><span class="mobile-nav-icon">âš¡</span>Dashboard</div>
    <div class="mobile-nav-item" onclick="showPage('cashflow')"><span class="mobile-nav-icon">ðŸ’¸</span>Cash Flow</div>
    <div class="mobile-nav-item" onclick="showPage('debts')"><span class="mobile-nav-icon">ðŸ’³</span>Accounts</div>
    <div class="mobile-nav-item" onclick="showPage('payoff')"><span class="mobile-nav-icon">ðŸ“ˆ</span>Payoff</div>
    <div class="mobile-nav-item" onclick="showPage('goals')"><span class="mobile-nav-icon">ðŸŽ¯</span>Goals</div>
    <div class="mobile-nav-item" onclick="showPage('forecast')"><span class="mobile-nav-icon">ðŸ”®</span>Forecast</div>
  </div>
</nav>

<!-- MODALS -->

<!-- Add/Edit Debt Modal -->

<div class="modal-backdrop" id="addDebtModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="debtModalTitle">Add Account</div>
      <button class="btn-icon" onclick="closeModal('addDebtModal')">âœ•</button>
    </div>
    <input type="hidden" id="editDebtId">
    <div class="form-group">
      <label class="form-label">Account Name</label>
      <input type="text" class="form-input" id="debtName" placeholder="e.g. Chase Sapphire">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-input" id="debtType">
          <option value="credit">Credit Card</option>
          <option value="loan">Personal Loan</option>
          <option value="auto">Auto Loan</option>
          <option value="student">Student Loan</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Current Balance ($)</label>
        <input type="number" class="form-input" id="debtBalance" placeholder="0.00">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">APR (%)</label>
        <input type="number" class="form-input" id="debtAPR" placeholder="0.00" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Min. Monthly Payment ($)</label>
        <input type="number" class="form-input" id="debtMinPayment" placeholder="0.00">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Credit Limit ($ optional)</label>
        <input type="number" class="form-input" id="debtLimit" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Due Date (day of month)</label>
        <input type="number" class="form-input" id="debtDueDate" min="1" max="31" placeholder="15">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <input type="text" class="form-input" id="debtNotes" placeholder="e.g. Used for all daily expenses">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeModal('addDebtModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDebt()">Save Account</button>
    </div>
  </div>
</div>

<!-- Add Income Modal -->

<div class="modal-backdrop" id="incomeModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add Income Source</div>
      <button class="btn-icon" onclick="closeModal('incomeModal')">âœ•</button>
    </div>
    <input type="hidden" id="editIncomeId">
    <div class="form-group">
      <label class="form-label">Income Name</label>
      <input type="text" class="form-input" id="incomeName" placeholder="e.g. Salary, Freelance">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Monthly Amount ($)</label>
        <input type="number" class="form-input" id="incomeAmount" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Frequency</label>
        <select class="form-input" id="incomeFrequency">
          <option value="monthly">Monthly</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="weekly">Weekly</option>
          <option value="annual">Annual</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeModal('incomeModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveIncome()">Save Income</button>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->

<div class="modal-backdrop" id="expenseModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add Expense</div>
      <button class="btn-icon" onclick="closeModal('expenseModal')">âœ•</button>
    </div>
    <input type="hidden" id="editExpenseId">
    <div class="form-group">
      <label class="form-label">Expense Name</label>
      <input type="text" class="form-input" id="expenseName" placeholder="e.g. Rent, Utilities">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Monthly Amount ($)</label>
        <input type="number" class="form-input" id="expenseAmount" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-input" id="expenseCategory">
          <option value="housing">Housing</option>
          <option value="food">Food & Groceries</option>
          <option value="transport">Transport</option>
          <option value="utilities">Utilities</option>
          <option value="subscriptions">Subscriptions</option>
          <option value="entertainment">Entertainment</option>
          <option value="health">Health</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeModal('expenseModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
    </div>
  </div>
</div>

<!-- Add Goal Modal -->

<div class="modal-backdrop" id="addGoalModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Savings Goal</div>
      <button class="btn-icon" onclick="closeModal('addGoalModal')">âœ•</button>
    </div>
    <input type="hidden" id="editGoalId">
    <div class="form-group">
      <label class="form-label">Goal Name</label>
      <input type="text" class="form-input" id="goalName" placeholder="e.g. Hawaii Vacation">
    </div>
    <div class="form-group">
      <label class="form-label">Goal Emoji / Icon</label>
      <input type="text" class="form-input" id="goalEmoji" placeholder="ðŸ–ï¸" maxlength="4">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Target Amount ($)</label>
        <input type="number" class="form-input" id="goalTarget" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Currently Saved ($)</label>
        <input type="number" class="form-input" id="goalSaved" placeholder="0.00">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Monthly Contribution ($)</label>
      <input type="number" class="form-input" id="goalMonthly" placeholder="0.00">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeModal('addGoalModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  debts: [],
  income: [],
  expenses: [],
  goals: [],
  settings: { extraPayment: 0, payoffStrategy: 'avalanche' },
  customPayments: {},
  forecast: { debtPayments: {}, goalContributions: {}, generalSavings: 0, forecastMonths: 36 }
};

// â”€â”€â”€ DEFAULT DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDefaults() {
  state.debts = [
    { id: '1', name: 'AMEX Blue Cash', type: 'credit', balance: 628.18, apr: 28.49, minPayment: 25, limit: 5000, dueDate: 15, notes: 'Daily spending card', included: true, color: '#5c7cff' },
    { id: '2', name: 'Chase Sapphire Reserve', type: 'credit', balance: 3000, apr: 28.00, minPayment: 60, limit: 10000, dueDate: 20, notes: 'Travel rewards card', included: true, color: '#a78bfa' },
    { id: '3', name: 'Parent Loan', type: 'loan', balance: 5800, apr: 0, minPayment: 0, limit: 0, dueDate: 1, notes: '0% interest family loan', included: true, color: '#22d47e' },
    { id: '4', name: 'Student Loans (Federal)', type: 'student', balance: 418417.65, apr: 6.125, minPayment: 2200, limit: 0, dueDate: 10, notes: 'Federal student loan portfolio', included: true, color: '#ffd43b' },
    { id: '5', name: 'Tesla Model Y', type: 'auto', balance: 36880.07, apr: 5.390, minPayment: 646.96, limit: 0, dueDate: 5, notes: '72-month auto loan', included: true, color: '#ff9f43' }
  ];
  state.income = [
    { id: '1', name: 'Primary Salary', amount: 7500, frequency: 'monthly' },
    { id: '2', name: 'Side Income', amount: 500, frequency: 'monthly' }
  ];
  state.expenses = [
    { id: '1', name: 'Rent', amount: 2200, category: 'housing' },
    { id: '2', name: 'Utilities & Internet', amount: 150, category: 'utilities' },
    { id: '3', name: 'Subscriptions', amount: 80, category: 'subscriptions' },
    { id: '4', name: 'Insurance', amount: 200, category: 'other' }
  ];
  state.goals = [
    { id: '1', name: 'Hawaii Vacation', emoji: 'ðŸ–ï¸', target: 3000, saved: 250, monthly: 200 },
    { id: '2', name: 'Emergency Fund', emoji: 'ðŸ›¡ï¸', target: 10000, saved: 1500, monthly: 300 }
  ];
}

// â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chartDefaults = {
  color: '#eef0f8',
  backgroundColor: 'transparent',
};
Chart.defaults.color = '#6b7299';
Chart.defaults.borderColor = 'rgba(255,255,255,0.07)';
Chart.defaults.font.family = "'DM Mono', monospace";
Chart.defaults.font.size = 11;

let charts = {};

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function getMonthlyIncome() {
  return state.income.reduce((s, i) => {
    let m = i.amount;
    if (i.frequency === 'biweekly') m = i.amount * 26 / 12;
    if (i.frequency === 'weekly') m = i.amount * 52 / 12;
    if (i.frequency === 'annual') m = i.amount / 12;
    return s + m;
  }, 0);
}

function getMonthlyExpenses() {
  return state.expenses.reduce((s, e) => s + e.amount, 0);
}

function getMinPayments() {
  return state.debts.filter(d => d.included).reduce((s, d) => s + d.minPayment, 0);
}

function getPlannedPayments() {
  return state.debts.filter(d => d.included).reduce((s, d) => {
    const p = state.forecast.debtPayments?.[d.id];
    const planned = typeof p === 'object' ? (p.default ?? d.minPayment) : (p || d.minPayment);
    return s + planned;
  }, 0);
}

function getTotalDebt(includedOnly = true) {
  return state.debts.filter(d => includedOnly ? d.included : true).reduce((s, d) => s + d.balance, 0);
}

function getMonthlyInterest() {
  return state.debts.filter(d => d.included).reduce((s, d) => s + (d.balance * d.apr / 100 / 12), 0);
}

function fmt(n) {
  if (n === undefined || n === null || isNaN(n)) return '$0';
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtMonthLabel(d) {
  // Always returns e.g. "Mar '26" â€” apostrophe before year so it can't be read as a day
  return d.toLocaleDateString('en-US', { month: 'short' }) + " '" + String(d.getFullYear()).slice(2);
}
function fmtK(n) {
  return fmt(n);
}
function fmtMonths(m) {
  if (!isFinite(m) || m <= 0) return 'Paid off';
  if (m > 600) return '50+ years';
  const yr = Math.floor(m / 12);
  const mo = Math.round(m % 12);
  if (yr === 0) return mo + ' months';
  if (mo === 0) return yr + ' yr' + (yr > 1 ? 's' : '');
  return yr + ' yr ' + mo + ' mo';
}
function addMonths(date, months) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + months);
  return d;
}
function monthsToPayoff(balance, apr, monthlyPayment) {
  if (balance <= 0) return 0;
  if (monthlyPayment <= 0) return Infinity;
  const r = apr / 100 / 12;
  if (r === 0) return Math.ceil(balance / monthlyPayment);
  if (monthlyPayment <= balance * r) return Infinity; // can't pay off
  return Math.ceil(-Math.log(1 - (balance * r) / monthlyPayment) / Math.log(1 + r));
}
function totalInterest(balance, apr, monthlyPayment) {
  if (balance <= 0) return 0;
  const r = apr / 100 / 12;
  if (r === 0) return 0;
  const n = monthsToPayoff(balance, apr, monthlyPayment);
  if (!isFinite(n)) return Infinity;
  return (monthlyPayment * n) - balance;
}

// â”€â”€â”€ RENDER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const income = getMonthlyIncome();
  const expenses = getMonthlyExpenses();
  const minP = getMinPayments();
  const surplus = income - expenses - minP;
  const totalDebt = getTotalDebt();

  document.getElementById('dashSubtitle').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('kpiIncome').textContent = fmt(income);
  document.getElementById('kpiExpenses').textContent = fmt(expenses + minP);
  const surplusEl = document.getElementById('kpiSurplus');
  surplusEl.textContent = fmt(Math.abs(surplus));
  surplusEl.className = 'kpi-value ' + (surplus >= 0 ? 'green' : 'red');
  document.getElementById('kpiSurplusSub').textContent = surplus >= 0 ? 'ðŸ’š Surplus after all payments' : 'ðŸ”´ Deficit â€” review spending';
  document.getElementById('kpiDebt').textContent = fmt(totalDebt);
  document.getElementById('kpiDebtSub').textContent = state.debts.filter(d=>d.included).length + ' accounts tracked';

  // Monthly Budget Breakdown bar (dashboard)
  // Two-row comparison: income bar (green) on top, spending breakdown below â€” same scale
  const dashBarScale = Math.max(income, expenses + minP, 1);
  const dashBarEl = document.getElementById('dashBudgetBar');
  const dashLegEl = document.getElementById('dashBudgetLegend');
  const dashTagEl = document.getElementById('dashBudgetTag');
  if (dashBarEl) {
    const incW = (income / dashBarScale * 100).toFixed(2);
    const expW = (expenses / dashBarScale * 100).toFixed(2);
    const debtW = (minP / dashBarScale * 100).toFixed(2);
    const surpW = Math.max(0, (surplus / dashBarScale * 100)).toFixed(2);
    const overW = surplus < 0 ? (Math.abs(surplus) / dashBarScale * 100).toFixed(2) : 0;
    const barStyle = 'display:flex;border-radius:8px;overflow:hidden;background:rgba(255,255,255,0.04);';
    // Row 1: Income bar (solid green, full width = income)
    const incomeRow = `<div style="${barStyle}height:14px;margin-bottom:5px;">
      <div style="width:${incW}%;background:#22d47e;height:100%;border-radius:8px;" title="Income: ${fmt(income)}"></div>
    </div>`;
    // Row 2: Expenses (red) + Debt (orange) + Surplus (green) or Over-budget (red stripe)
    const spendRow = `<div style="${barStyle}height:22px;">
      ${expenses > 0.01 ? `<div style="width:${expW}%;background:#ff5b6b;height:100%;" title="Fixed Expenses: ${fmt(expenses)}"></div>` : ''}
      ${minP > 0.01 ? `<div style="width:${debtW}%;background:#ff9f43;height:100%;" title="Debt Payments: ${fmt(minP)}"></div>` : ''}
      ${surplus > 0.01 ? `<div style="width:${surpW}%;background:rgba(34,212,126,0.35);height:100%;border-left:2px solid rgba(34,212,126,0.5);" title="Surplus: ${fmt(surplus)}"></div>` : ''}
      ${surplus < -0.01 ? `<div style="width:${overW}%;background:repeating-linear-gradient(45deg,rgba(255,91,107,0.6),rgba(255,91,107,0.6) 4px,rgba(255,91,107,0.2) 4px,rgba(255,91,107,0.2) 8px);height:100%;border-left:2px solid #ff5b6b;" title="Over Budget: ${fmt(Math.abs(surplus))}"></div>` : ''}
    </div>`;
    dashBarEl.innerHTML = incomeRow + spendRow;
  }
  if (dashLegEl) dashLegEl.innerHTML = [
    `<div class="fc-legend-item"><span class="fc-budget-dot" style="background:#22d47e"></span>Income:&nbsp;<span style="color:#22d47e;">${fmt(income)}/mo</span></div>`,
    expenses > 0.01 ? `<div class="fc-legend-item"><span class="fc-budget-dot" style="background:#ff5b6b"></span>Expenses:&nbsp;<span>${fmt(expenses)}</span></div>` : '',
    minP > 0.01 ? `<div class="fc-legend-item"><span class="fc-budget-dot" style="background:#ff9f43"></span>Debt Payments:&nbsp;<span>${fmt(minP)}</span></div>` : '',
    surplus > 0.01 ? `<div class="fc-legend-item"><span class="fc-budget-dot" style="background:rgba(34,212,126,0.6)"></span>Surplus:&nbsp;<span style="color:#22d47e;">${fmt(surplus)}</span></div>` : '',
  ].join('');
  if (dashTagEl) { dashTagEl.textContent = surplus >= 0 ? `+${fmt(surplus)} surplus` : `${fmt(Math.abs(surplus))} over`; dashTagEl.style.cssText = `background:${surplus>=0?'rgba(34,212,126,0.15)':'rgba(255,91,107,0.15)'};color:${surplus>=0?'#22d47e':'#ff5b6b'};font-size:11px;font-weight:700;font-family:'DM Mono',monospace;padding:4px 12px;border-radius:99px;`; }

  // Net Surplus bar chart
  const surplusAmountEl = document.getElementById('netSurplusAmount');
  const surplusLabelEl = document.getElementById('netSurplusLabel');
  const surplusDescEl = document.getElementById('netSurplusDesc');
  surplusAmountEl.textContent = (surplus < 0 ? '-' : '') + fmt(Math.abs(surplus));
  surplusAmountEl.style.color = surplus >= 0 ? '#22d47e' : '#ff5b6b';
  surplusLabelEl.style.color = surplus >= 0 ? '#22d47e' : '#ff5b6b';
  surplusDescEl.textContent = surplus >= 0 ? 'available after all expenses & debt payments' : 'deficit â€” spending exceeds income';

  // Net surplus bar: income goes UP (positive), expenses/debt go DOWN (negative), surplus floats at top or bottom
  destroyChart('netSurplus');
  const ctxNS = document.getElementById('netSurplusChart').getContext('2d');
  const nsData = [income, -expenses, -minP, surplus];
  const nsColors = [
    'rgba(34,212,126,0.85)',
    'rgba(255,91,107,0.85)',
    'rgba(255,159,67,0.85)',
    surplus >= 0 ? 'rgba(92,124,255,0.85)' : 'rgba(255,91,107,0.9)'
  ];
  const nsBorder = ['#22d47e', '#ff5b6b', '#ff9f43', surplus >= 0 ? '#5c7cff' : '#ff5b6b'];
  charts['netSurplus'] = new Chart(ctxNS, {
    type: 'bar',
    data: {
      labels: ['Income', 'Expenses', 'Debt Payments', surplus >= 0 ? 'Net Surplus' : 'Deficit'],
      datasets: [{
        data: nsData,
        backgroundColor: nsColors,
        borderColor: nsBorder,
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ' ' + fmtK(Math.abs(c.raw)) } }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          ticks: { callback: v => fmtK(Math.abs(v)) },
          grid: { color: ctx => ctx.tick.value === 0 ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.04)' }
        }
      }
    }
  });

  // Income vs Expenses chart
  destroyChart('incomeExpense');
  const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
  charts['incomeExpense'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['Income', 'Fixed Expenses', 'Debt Payments', 'Net Surplus'],
      datasets: [{
        data: [income, expenses, minP, Math.max(surplus, 0)],
        backgroundColor: ['rgba(34,212,126,.7)', 'rgba(255,91,107,.7)', 'rgba(255,159,67,.7)', 'rgba(92,124,255,.7)'],
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ' ' + fmtK(c.raw) } } },
      scales: {
        x: { grid: { display: false } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });

  // Debt pie chart
  destroyChart('debtPie');
  const included = state.debts.filter(d => d.included && d.balance > 0);
  const ctx2 = document.getElementById('debtPieChart').getContext('2d');
  charts['debtPie'] = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: included.map(d => d.name),
      datasets: [{
        data: included.map(d => d.balance),
        backgroundColor: included.map(d => d.color + 'cc'),
        borderColor: included.map(d => d.color),
        borderWidth: 2,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 10, padding: 12 } },
        tooltip: { callbacks: { label: c => ' ' + fmt(c.raw) } }
      }
    }
  });

  // Surplus allocation
  const allocEl = document.getElementById('surplusAllocationList');
  if (surplus > 0) {
    const included2 = state.debts.filter(d => d.included && d.balance > 0 && d.apr > 0);
    const sorted = [...included2].sort((a, b) => b.apr - a.apr);
    let html = '';
    let rem = surplus;
    for (const d of sorted) {
      const alloc = Math.min(rem, d.minPayment * 2);
      const pct = Math.min(100, (alloc / surplus) * 100);
      html += `<div class="alloc-item">
        <div class="alloc-header"><span class="alloc-name">${d.name}</span><span class="alloc-amount">${fmt(alloc)}</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${d.color}"></div></div>
      </div>`;
      rem -= alloc;
      if (rem <= 0) break;
    }
    if (rem > 0) html += `<div class="alloc-item"><div class="alloc-header"><span class="alloc-name">ðŸ’° Remaining Surplus</span><span class="alloc-amount" style="color:var(--green)">${fmt(rem)}</span></div></div>`;
    allocEl.innerHTML = html;
  } else {
    allocEl.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-text">Deficit detected â€” consider reducing expenses</div></div>`;
  }

  // Quick account summary
  const qEl = document.getElementById('quickAccountSummary');
  qEl.innerHTML = state.debts.slice(0, 5).map(d => `
    <div class="cf-row">
      <div>
        <div style="font-size:13px;font-weight:700;">${d.name}</div>
        <div style="font-size:11px;color:var(--muted);font-family:var(--mono);">${d.apr}% APR ${d.included ? '' : 'Â· <span style="color:var(--orange)">Excluded</span>'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:var(--mono);font-size:14px;color:var(--red);">${fmt(d.balance)}</div>
        <div style="font-size:10px;color:var(--muted);font-family:var(--mono);">min ${fmt(d.minPayment)}/mo</div>
      </div>
    </div>
  `).join('');
}

// â”€â”€â”€ RENDER CASH FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCashFlow() {
  const income = getMonthlyIncome();
  const expenses = getMonthlyExpenses();
  const plannedP = getPlannedPayments();
  const surplus = income - expenses - plannedP;
  document.getElementById('cfIncome').textContent = fmt(income);
  document.getElementById('cfExpenses').textContent = fmt(expenses + plannedP);
  const el = document.getElementById('cfSurplus');
  el.textContent = fmt(Math.abs(surplus));
  el.className = 'kpi-value ' + (surplus >= 0 ? 'green' : 'red');

  // Income list
  const incEl = document.getElementById('incomeList');
  if (state.income.length === 0) {
    incEl.innerHTML = `<div class="empty"><div class="empty-icon">ðŸ’°</div><div class="empty-text">No income added yet</div></div>`;
  } else {
    incEl.innerHTML = state.income.map(i => {
      let monthly = i.amount;
      if (i.frequency === 'biweekly') monthly = i.amount * 26 / 12;
      if (i.frequency === 'weekly') monthly = i.amount * 52 / 12;
      if (i.frequency === 'annual') monthly = i.amount / 12;
      return `<div class="cf-row">
        <div>
          <div class="cf-label">${i.name}</div>
          <div style="font-size:11px;color:var(--muted);text-transform:capitalize;">${i.frequency}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="cf-amount income">${fmt(monthly)}<span style="color:var(--muted);font-size:10px;">/mo</span></div>
          <button class="btn-icon btn-sm" onclick="editIncome('${i.id}')">âœï¸</button>
          <button class="btn-icon btn-sm" onclick="deleteIncome('${i.id}')">ðŸ—‘</button>
        </div>
      </div>`;
    }).join('');
  }

  // Expense list
  const expEl = document.getElementById('expenseList');
  if (state.expenses.length === 0) {
    expEl.innerHTML = `<div class="empty"><div class="empty-icon">ðŸ’³</div><div class="empty-text">No expenses added yet</div></div>`;
  } else {
    expEl.innerHTML = state.expenses.map(e => `
      <div class="cf-row">
        <div>
          <div class="cf-label">${e.name}</div>
          <div style="font-size:11px;color:var(--muted);text-transform:capitalize;">${e.category}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="cf-amount expense">${fmt(e.amount)}<span style="color:var(--muted);font-size:10px;">/mo</span></div>
          <button class="btn-icon btn-sm" onclick="editExpense('${e.id}')">âœï¸</button>
          <button class="btn-icon btn-sm" onclick="deleteExpense('${e.id}')">ðŸ—‘</button>
        </div>
      </div>
    `).join('');
  }

  // Debt payments section â€” always show individual debts with planned amounts
  const includedDebts = state.debts.filter(d => d.included);
  const debtHtml = includedDebts.length === 0 ? '' : (() => {
    const now = new Date();
    const debtRows = includedDebts.map(d => {
      const p = state.forecast.debtPayments?.[d.id];
      const planned = typeof p === 'object' ? (p.default ?? d.minPayment) : (p || d.minPayment);
      const isPlanned = planned !== d.minPayment;
      const payoffMos = monthsToPayoff(d.balance, d.apr, planned);
      let payoffStr;
      if (payoffMos === 0) payoffStr = 'âœ“ Paid off';
      else if (!isFinite(payoffMos)) payoffStr = 'âš  Won\'t pay off';
      else { const pd = new Date(now.getFullYear(), now.getMonth() + payoffMos, 1); payoffStr = 'Payoff: ' + pd.toLocaleDateString('en-US', {month:'short',year:'numeric'}); }
      const dot = `<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${d.color};margin-right:5px;vertical-align:middle;"></span>`;
      return `<div class="cf-row">
        <div>
          <div class="cf-label">${dot}${d.name}</div>
          <div style="font-size:11px;color:var(--muted);">${d.apr}% APR Â· ${payoffStr}</div>
        </div>
        <div>
          <div class="cf-amount expense">${fmt(planned)}<span style="color:var(--muted);font-size:10px;">/mo</span></div>
          <div style="font-size:10px;text-align:right;color:${isPlanned?'#5c7cff':'var(--muted)'};">${isPlanned?'planned':'min.'}</div>
        </div>
      </div>`;
    }).join('');
    const total = includedDebts.length > 1
      ? `<div class="cf-row" style="border-top:1px solid rgba(255,255,255,0.06);margin-top:2px;padding-top:6px;"><strong>Total Debt Payments</strong><span class="cf-amount expense">${fmt(plannedP)}/mo</span></div>`
      : '';
    return `<div style="border-top:2px solid var(--border);margin-top:${state.expenses.length?'4':'0'}px;padding-top:6px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#6b7299;margin-bottom:4px;">Debt Payments</div>
      ${debtRows}${total}</div>`;
  })();
  expEl.innerHTML += debtHtml;

  // Cashflow trend (simulated 6 months)
  destroyChart('cft');
  const months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const incomeData = months.map(() => income * (0.95 + Math.random() * 0.1));
  const expData = months.map(() => (expenses + plannedP) * (0.9 + Math.random() * 0.2));
  const ctx = document.getElementById('cashflowTrendChart').getContext('2d');
  charts['cft'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        { label: 'Income', data: incomeData, borderColor: '#22d47e', backgroundColor: 'rgba(34,212,126,.1)', fill: true, tension: .4, pointRadius: 4 },
        { label: 'Expenses', data: expData, borderColor: '#ff5b6b', backgroundColor: 'rgba(255,91,107,.1)', fill: true, tension: .4, pointRadius: 4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true }, tooltip: { callbacks: { label: c => ' ' + fmt(c.raw) } } },
      scales: {
        x: { grid: { display: false } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });
}

// â”€â”€â”€ RENDER DEBTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let debtFilter = 'all';
function filterDebts(type, el) {
  debtFilter = type;
  document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  renderDebts();
}

function renderDebts() {
  const included = state.debts.filter(d => d.included);
  document.getElementById('debtTotalIncluded').textContent = fmt(getTotalDebt());
  document.getElementById('debtMonthlyInterest').textContent = fmt(getMonthlyInterest());
  document.getElementById('debtMinPayments').textContent = fmt(getMinPayments());

  const filtered = debtFilter === 'all' ? state.debts : state.debts.filter(d => d.type === debtFilter);
  const el = document.getElementById('debtList');
  if (filtered.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ðŸŽ‰</div><div class="empty-text">No accounts in this category</div></div>`;
    return;
  }
  el.innerHTML = filtered.map(d => {
    const pct = d.limit > 0 ? Math.min(100, (d.balance / d.limit) * 100) : 0;
    const colors = { credit: 'badge-cc', loan: 'badge-loan', auto: 'badge-auto', student: 'badge-student' };
    const labels = { credit: 'Credit Card', loan: 'Personal Loan', auto: 'Auto Loan', student: 'Student Loan' };
    const monthlyInt = d.balance * d.apr / 100 / 12;
    const mos = monthsToPayoff(d.balance, d.apr, d.minPayment);
    return `
    <div class="debt-item${d.included ? '' : ' excluded'}" id="debt-${d.id}">
      <div class="debt-item-header">
        <div class="debt-name">
          <div style="width:10px;height:10px;border-radius:50%;background:${d.color};flex-shrink:0;"></div>
          ${d.name}
          <span class="debt-badge ${colors[d.type]}">${labels[d.type]}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle" title="${d.included ? 'Included in calculations' : 'Excluded from calculations'}">
            <input type="checkbox" ${d.included ? 'checked' : ''} onchange="toggleDebt('${d.id}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:10px;">
        <div class="debt-balance">${fmt(d.balance)}</div>
        ${d.limit > 0 ? `<div style="font-size:11px;color:var(--muted);font-family:var(--mono);">${pct.toFixed(0)}% of ${fmtK(d.limit)} limit</div>` : ''}
      </div>
      ${d.limit > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${pct > 80 ? 'var(--red)' : pct > 50 ? 'var(--orange)' : d.color}"></div></div>` : ''}
      <div class="debt-meta" style="margin-top:8px;">
        <div class="debt-meta-item">APR <span>${d.apr}%</span></div>
        <div class="debt-meta-item">Min Payment <span>${fmt(d.minPayment)}/mo</span></div>
        <div class="debt-meta-item">Monthly Interest <span style="color:var(--orange)">${fmt(monthlyInt)}</span></div>
        ${mos > 0 && isFinite(mos) ? `<div class="debt-meta-item">Payoff (min) <span>${fmtMonths(mos)}</span></div>` : ''}
        ${d.dueDate ? `<div class="debt-meta-item">Due <span>Day ${d.dueDate}</span></div>` : ''}
      </div>
      ${d.notes ? `<div style="font-size:11px;color:var(--muted);margin-top:8px;font-style:italic;">${d.notes}</div>` : ''}
      <div class="debt-actions">
        <button class="btn btn-ghost btn-sm" onclick="editDebt('${d.id}')">âœï¸ Edit</button>
        <button class="btn btn-sm" onclick="quickUpdateBalance('${d.id}')" style="background:rgba(92,124,255,.15);color:var(--accent);border:1px solid rgba(92,124,255,.2);font-family:var(--font);font-size:11px;font-weight:700;padding:6px 12px;border-radius:9px;cursor:pointer;letter-spacing:.5px;">ðŸ’³ Update Balance</button>
        <button class="btn btn-danger btn-sm" onclick="deleteDebt('${d.id}')">ðŸ—‘ Remove</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ RENDER PAYOFF PLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalcPayoff() {
  const strategy = document.getElementById('payoffStrategy').value;
  const extra = parseFloat(document.getElementById('extraPayment').value) || 0;
  const income = getMonthlyIncome();
  const expenses = getMonthlyExpenses();
  const surplus = income - expenses;
  const minP = getMinPayments();
  const totalAvail = Math.max(0, surplus);

  document.getElementById('totalForDebt').textContent = fmt(totalAvail);
  document.getElementById('payoffMinTotal').textContent = fmt(minP);
  document.getElementById('payoffExtraTotal').textContent = fmt(extra);

  // Build custom payment inputs if needed
  const customArea = document.getElementById('customPayoffArea');
  if (strategy === 'custom') {
    customArea.innerHTML = `<div class="card-title" style="margin-bottom:8px;">Custom Monthly Payments</div>` +
      state.debts.filter(d => d.included && d.balance > 0).map(d => {
        const val = state.customPayments[d.id] || d.minPayment;
        return `<div class="alloc-item">
          <div class="alloc-header">
            <span class="alloc-name">${d.name}</span>
            <span class="alloc-amount" id="cpa-${d.id}">${fmt(val)}</span>
          </div>
          <input type="range" class="range-input" min="${d.minPayment}" max="${Math.max(d.balance, d.minPayment * 5)}" step="10" value="${val}"
            oninput="state.customPayments['${d.id}']=parseFloat(this.value);document.getElementById('cpa-${d.id}').textContent=fmt(parseFloat(this.value));runPayoffCalc()">
        </div>`;
      }).join('');
  } else {
    customArea.innerHTML = '';
  }

  runPayoffCalc();
}

function runPayoffCalc() {
  const strategy = document.getElementById('payoffStrategy').value;
  const extra = parseFloat(document.getElementById('extraPayment').value) || 0;
  const debts = state.debts.filter(d => d.included && d.balance > 0).map(d => ({ ...d }));

  if (debts.length === 0) return;

  // Simulate payoff
  const MONTHS = 600;
  const balanceHistory = {};
  debts.forEach(d => { balanceHistory[d.id] = [d.balance]; });

  let sortedDebts = [...debts];
  if (strategy === 'avalanche') sortedDebts.sort((a, b) => b.apr - a.apr);
  else if (strategy === 'snowball') sortedDebts.sort((a, b) => a.balance - b.balance);

  const payoffDates = {};
  const monthlyData = []; // total debt each month
  let totalDebt = debts.reduce((s, d) => s + d.balance, 0);

  let simDebts = debts.map(d => ({ ...d }));
  for (let m = 0; m < MONTHS; m++) {
    let extraLeft = extra;
    let monthTotal = 0;
    for (const d of simDebts) {
      if (d.balance <= 0) continue;
      const interest = d.balance * d.apr / 100 / 12;
      d.balance += interest;
      let payment = strategy === 'custom' ? (state.customPayments[d.id] || d.minPayment) : d.minPayment;
      payment = Math.min(payment, d.balance);
      d.balance -= payment;
      if (d.balance < 0) d.balance = 0;
    }
    // Apply extra
    if (strategy !== 'custom') {
      for (const d of sortedDebts) {
        const found = simDebts.find(x => x.id === d.id);
        if (!found || found.balance <= 0) continue;
        const p = Math.min(extraLeft, found.balance);
        found.balance -= p;
        extraLeft -= p;
        if (extraLeft <= 0) break;
      }
    }
    for (const d of simDebts) {
      if (d.balance <= 0 && !payoffDates[d.id]) payoffDates[d.id] = m;
      if (!balanceHistory[d.id]) balanceHistory[d.id] = [];
      balanceHistory[d.id].push(Math.max(0, d.balance));
      monthTotal += d.balance;
    }
    monthlyData.push(monthTotal);
    if (simDebts.every(d => d.balance <= 0)) break;
  }

  // Render timeline
  const tlEl = document.getElementById('payoffTimeline');
  const colors = ['#5c7cff', '#a78bfa', '#22d47e', '#ffd43b', '#ff9f43', '#ff5b6b'];
  const now = new Date();
  tlEl.innerHTML = debts.map((d, i) => {
    const m = payoffDates[d.id];
    const payoffDate = m !== undefined ? addMonths(now, m) : null;
    const intPaid = m !== undefined ? totalInterest(d.balance, d.apr, d.minPayment + (strategy !== 'custom' ? extra / debts.length : 0)) : Infinity;
    return `<div class="payoff-item">
      <div class="payoff-dot" style="background:${d.color || colors[i % colors.length]}"></div>
      <div class="payoff-info">
        <div class="payoff-name">${d.name}</div>
        <div class="payoff-date">${payoffDate ? payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'âš ï¸ Insufficient payment'} Â· ${fmtMonths(m)}</div>
      </div>
      <div class="payoff-interest">${isFinite(intPaid) ? '+' + fmtK(intPaid) + ' interest' : 'âˆž'}</div>
    </div>`;
  }).join('');

  // Payoff chart
  destroyChart('payoff');
  const maxM = Math.min(Math.max(...Object.values(payoffDates).filter(isFinite), 60) + 6, 360);
  const labels = Array.from({ length: maxM }, (_, i) => {
    const d = addMonths(now, i);
    return fmtMonthLabel(d);
  });
  const ctx = document.getElementById('payoffChart').getContext('2d');
  charts['payoff'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: debts.map((d, i) => ({
        label: d.name,
        data: (balanceHistory[d.id] || []).slice(0, maxM),
        borderColor: d.color || colors[i % colors.length],
        backgroundColor: 'transparent',
        tension: .3,
        pointRadius: 0,
        borderWidth: 2
      })).concat([{
        label: 'Total Debt',
        data: monthlyData.slice(0, maxM),
        borderColor: '#ffffff33',
        backgroundColor: 'rgba(255,255,255,.03)',
        fill: true,
        tension: .3,
        pointRadius: 0,
        borderWidth: 1,
        borderDash: [5, 5]
      }])
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true }, tooltip: { callbacks: { label: c => ' ' + fmt(c.raw) } } },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 12 } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });

  // Interest comparison
  destroyChart('interestComp');
  const minOnlyInterest = debts.map(d => totalInterest(d.balance, d.apr, d.minPayment));
  const withExtraInterest = debts.map(d => totalInterest(d.balance, d.apr, d.minPayment + extra / Math.max(debts.length, 1)));
  const ctx2 = document.getElementById('interestCompChart').getContext('2d');
  charts['interestComp'] = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: debts.map(d => d.name),
      datasets: [
        { label: 'Min Payments Only', data: minOnlyInterest.map(v => isFinite(v) ? v : 0), backgroundColor: 'rgba(255,91,107,.7)', borderRadius: 6 },
        { label: 'With Extra Payment', data: withExtraInterest.map(v => isFinite(v) ? v : 0), backgroundColor: 'rgba(34,212,126,.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true }, tooltip: { callbacks: { label: c => ' Total interest: ' + fmt(c.raw) } } },
      scales: {
        x: { grid: { display: false } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });
}

function renderPayoff() {
  document.getElementById('payoffStrategy').value = state.settings.payoffStrategy || 'avalanche';
  document.getElementById('extraPayment').value = state.settings.extraPayment || 0;
  recalcPayoff();
}

// â”€â”€â”€ RENDER GOALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGoals() {
  const totalSaved = state.goals.reduce((s, g) => s + g.saved, 0);
  const totalTarget = state.goals.reduce((s, g) => s + g.target, 0);
  document.getElementById('goalsTotalSaved').textContent = fmt(totalSaved);
  document.getElementById('goalsTotalTarget').textContent = fmt(totalTarget);

  const surplus = getMonthlyIncome() - getMonthlyExpenses() - getMinPayments();
  const totalGoalMonthly = state.goals.reduce((s, g) => s + g.monthly, 0);
  const remaining = totalTarget - totalSaved;
  const months = totalGoalMonthly > 0 ? Math.ceil(remaining / totalGoalMonthly) : Infinity;
  document.getElementById('goalsTotalMonths').textContent = fmtMonths(months);

  const el = document.getElementById('goalsList');
  if (state.goals.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ðŸŽ¯</div><div class="empty-text">No goals yet. Add your first savings goal!</div></div>`;
    return;
  }
  el.innerHTML = state.goals.map(g => {
    const pct = Math.min(100, (g.saved / g.target) * 100);
    const remaining = g.target - g.saved;
    const months = g.monthly > 0 ? Math.ceil(remaining / g.monthly) : Infinity;
    const payoffDate = months < Infinity ? addMonths(new Date(), months) : null;
    return `<div class="goal-item">
      <div class="goal-header">
        <div class="goal-name">${g.emoji || 'ðŸŽ¯'} ${g.name}</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="goal-amount">${fmt(g.saved)} / ${fmt(g.target)}</div>
          <button class="btn-icon btn-sm" onclick="editGoal('${g.id}')">âœï¸</button>
          <button class="btn-icon btn-sm" onclick="deleteGoal('${g.id}')">ðŸ—‘</button>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div></div>
      <div class="goal-progress-text">${pct.toFixed(1)}% complete Â· ${fmt(remaining)} remaining Â· ${fmt(g.monthly)}/mo contribution${payoffDate ? ' Â· ðŸ ' + payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : ' Â· â³ No target date'}</div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ RENDER FORECAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _fcDebounce;

// â”€â”€ State migration & helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fcMigrateState() {
  if (!state.forecast) state.forecast = {};
  if (!state.forecast.debtPayments) state.forecast.debtPayments = {};
  if (!state.forecast.expensePlanned) state.forecast.expensePlanned = {};
  if (!state.forecast.goalContributions) state.forecast.goalContributions = {};
  if (!state.forecast.generalSavingsMonths) state.forecast.generalSavingsMonths = {};
  if (!state.forecast.incomeMonths) state.forecast.incomeMonths = {};
  // Migrate flat-number format â†’ {default, months} objects
  for (const id of Object.keys(state.forecast.debtPayments)) {
    const v = state.forecast.debtPayments[id];
    if (typeof v === 'number') state.forecast.debtPayments[id] = { default: v, months: {} };
  }
  for (const id of Object.keys(state.forecast.expensePlanned)) {
    const v = state.forecast.expensePlanned[id];
    if (typeof v === 'number') state.forecast.expensePlanned[id] = { default: v, months: {} };
  }
  for (const id of Object.keys(state.forecast.goalContributions)) {
    const v = state.forecast.goalContributions[id];
    if (typeof v === 'number') state.forecast.goalContributions[id] = { default: v, months: {} };
  }
}

function getPlannedGoalContrib(goalId, month) {
  const p = state.forecast.goalContributions?.[goalId];
  if (!p && p !== 0) return 0;
  if (typeof p === 'number') return p;
  const override = p.months?.[String(month)];
  return override !== undefined ? override : (p.default !== undefined ? p.default : 0);
}

function getPlannedIncome(month) {
  const def = getMonthlyIncome();
  const ov = (state.forecast.incomeMonths || {})[String(month)];
  return ov !== undefined ? ov : def;
}

function fcIncomeMonthChange(month, val, el) {
  fcMigrateState();
  const v = parseFloat(val);
  if (isNaN(v) || val === '') {
    delete state.forecast.incomeMonths[String(month)];
    if (el) el.classList.remove('modified');
  } else {
    state.forecast.incomeMonths[String(month)] = v;
    if (el) el.classList.add('modified');
  }
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function getPlannedGeneralSavings(month) {
  const def = typeof state.forecast.generalSavings === 'number' ? state.forecast.generalSavings : 0;
  const overrides = state.forecast.generalSavingsMonths || {};
  const ov = overrides[String(month)];
  return ov !== undefined ? ov : def;
}

function getPlannedDebtPayment(debtId, month) {
  const p = state.forecast.debtPayments?.[debtId];
  const debt = state.debts.find(d => d.id === debtId);
  const fallback = debt?.minPayment || 0;
  if (!p) return fallback;
  if (typeof p === 'number') return p;
  const override = p.months?.[String(month)];
  return override !== undefined ? override : (p.default !== undefined ? p.default : fallback);
}

function getPlannedExpenseAmount(expId, month) {
  const p = state.forecast.expensePlanned?.[expId];
  const expense = state.expenses.find(e => e.id === expId);
  const fallback = expense?.amount || 0;
  if (!p) return fallback;
  if (typeof p === 'number') return p;
  const override = p.months?.[String(month)];
  return override !== undefined ? override : (p.default !== undefined ? p.default : fallback);
}

function getCategoryEmoji(cat) {
  const map = { housing:'ðŸ ', food:'ðŸ”', transport:'ðŸš—', utilities:'âš¡', subscriptions:'ðŸ“±', entertainment:'ðŸŽ¬', health:'ðŸ¥', other:'ðŸ“‹' };
  return map[cat] || 'ðŸ’°';
}

// â”€â”€ Input handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fcDebtInputChange(debtId, value) {
  fcMigrateState();
  const amount = Math.max(0, parseFloat(value) || 0);
  if (!state.forecast.debtPayments[debtId]) {
    state.forecast.debtPayments[debtId] = { default: amount, months: {} };
  } else {
    state.forecast.debtPayments[debtId].default = amount;
  }
  document.querySelectorAll(`input[data-debt-id="${debtId}"]`).forEach(inp => { if (!inp.classList.contains('modified')) inp.placeholder = amount; });
  _fcUpdateDebtRow(debtId, amount);
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcTblBalanceChange(debtId, value) {
  const d = state.debts.find(x => x.id === debtId);
  if (!d) return;
  d.balance = Math.max(0, parseFloat(value) || 0);
  saveToStorage();
  if (typeof renderDebts === 'function') renderDebts();
  const p = state.forecast.debtPayments?.[debtId];
  const payment = typeof p === 'object' ? (p?.default ?? d.minPayment) : (p || d.minPayment);
  _fcUpdateDebtRow(debtId, payment);
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 100);
}

function fcTblAprChange(debtId, value) {
  const d = state.debts.find(x => x.id === debtId);
  if (!d) return;
  d.apr = Math.max(0, parseFloat(value) || 0);
  saveToStorage();
  if (typeof renderDebts === 'function') renderDebts();
  const p = state.forecast.debtPayments?.[debtId];
  const payment = typeof p === 'object' ? (p?.default ?? d.minPayment) : (p || d.minPayment);
  _fcUpdateDebtRow(debtId, payment);
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 100);
}

function fcGoalInputChange(goalId, value) {
  fcMigrateState();
  const amount = Math.max(0, parseFloat(value) || 0);
  if (!state.forecast.goalContributions[goalId] || typeof state.forecast.goalContributions[goalId] === 'number') {
    state.forecast.goalContributions[goalId] = { default: amount, months: {} };
  } else {
    state.forecast.goalContributions[goalId].default = amount;
  }
  document.querySelectorAll(`input[data-goal-id="${goalId}"]`).forEach(inp => { if (!inp.classList.contains('modified')) inp.placeholder = amount; });
  _fcUpdateGoalRow(goalId, amount);
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcSavingsInputChange(value) {
  const amount = Math.max(0, parseFloat(value) || 0);
  state.forecast.generalSavings = amount;
  document.querySelectorAll('input[data-gensav="1"]').forEach(inp => { if (!inp.classList.contains('modified')) inp.placeholder = amount; });
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcGoalMonthChange(goalId, month, value, el) {
  fcMigrateState();
  if (!state.forecast.goalContributions[goalId]) state.forecast.goalContributions[goalId] = { default: 0, months: {} };
  const amount = parseFloat(value);
  if (isNaN(amount) || value === '') {
    delete state.forecast.goalContributions[goalId].months[String(month)];
    if (el) el.classList.remove('modified');
  } else {
    state.forecast.goalContributions[goalId].months[String(month)] = Math.max(0, amount);
    if (el) el.classList.add('modified');
  }
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcGeneralSavingsMonthChange(month, value, el) {
  fcMigrateState();
  if (!state.forecast.generalSavingsMonths) state.forecast.generalSavingsMonths = {};
  const amount = parseFloat(value);
  if (isNaN(amount) || value === '') {
    delete state.forecast.generalSavingsMonths[String(month)];
    if (el) el.classList.remove('modified');
  } else {
    state.forecast.generalSavingsMonths[String(month)] = Math.max(0, amount);
    if (el) el.classList.add('modified');
  }
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcClearGoalMonths(goalId) {
  fcMigrateState();
  if (state.forecast.goalContributions[goalId]) state.forecast.goalContributions[goalId].months = {};
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  for (let m = 0; m < MONTHS; m++) {
    const inp = document.getElementById('fc-gi-' + goalId + '-' + m);
    if (inp) { inp.value = ''; inp.classList.remove('modified'); }
  }
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcClearGeneralSavingsMonths() {
  state.forecast.generalSavingsMonths = {};
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  for (let m = 0; m < MONTHS; m++) {
    const inp = document.getElementById('fc-gsi-' + m);
    if (inp) { inp.value = ''; inp.classList.remove('modified'); }
  }
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcSaveMonths(value) {
  state.forecast.forecastMonths = parseInt(value) || 36;
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 100);
}

function fcDebtMonthChange(debtId, month, value, el) {
  fcMigrateState();
  if (!state.forecast.debtPayments[debtId]) {
    const debt = state.debts.find(d => d.id === debtId);
    state.forecast.debtPayments[debtId] = { default: debt?.minPayment || 0, months: {} };
  }
  const amount = parseFloat(value);
  if (isNaN(amount) || value === '') {
    delete state.forecast.debtPayments[debtId].months[String(month)];
    if (el) el.classList.remove('modified');
  } else {
    state.forecast.debtPayments[debtId].months[String(month)] = Math.max(0, amount);
    if (el) el.classList.add('modified');
  }
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcExpenseDefaultChange(expId, value) {
  fcMigrateState();
  const amount = Math.max(0, parseFloat(value) || 0);
  if (!state.forecast.expensePlanned[expId]) {
    state.forecast.expensePlanned[expId] = { default: amount, months: {} };
  } else {
    state.forecast.expensePlanned[expId].default = amount;
  }
  document.querySelectorAll(`input[data-exp-id="${expId}"]`).forEach(inp => { if (!inp.classList.contains('modified')) inp.placeholder = amount; });
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcExpenseMonthChange(expId, month, value, el) {
  fcMigrateState();
  if (!state.forecast.expensePlanned[expId]) {
    const exp = state.expenses.find(e => e.id === expId);
    state.forecast.expensePlanned[expId] = { default: exp?.amount || 0, months: {} };
  }
  const amount = parseFloat(value);
  if (isNaN(amount) || value === '') {
    delete state.forecast.expensePlanned[expId].months[String(month)];
    if (el) el.classList.remove('modified');
  } else {
    state.forecast.expensePlanned[expId].months[String(month)] = Math.max(0, amount);
    if (el) el.classList.add('modified');
  }
  saveToStorage();
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcFillAllDebtMonths(debtId) {
  fcMigrateState();
  const p = state.forecast.debtPayments[debtId];
  const def = (p && typeof p === 'object') ? (p.default || 0) : (p || 0);
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  for (let m = 0; m < MONTHS; m++) {
    state.forecast.debtPayments[debtId].months[String(m)] = def;
    const inp = document.getElementById('fc-mi-' + debtId + '-' + m);
    if (inp) { inp.value = def; inp.classList.add('modified'); }
  }
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcClearDebtMonths(debtId) {
  fcMigrateState();
  if (state.forecast.debtPayments[debtId]) state.forecast.debtPayments[debtId].months = {};
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  for (let m = 0; m < MONTHS; m++) {
    const inp = document.getElementById('fc-mi-' + debtId + '-' + m);
    if (inp) { inp.value = ''; inp.classList.remove('modified'); }
  }
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcClearExpenseMonths(expId) {
  fcMigrateState();
  if (state.forecast.expensePlanned[expId]) state.forecast.expensePlanned[expId].months = {};
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  for (let m = 0; m < MONTHS; m++) {
    const inp = document.getElementById('fc-ei-' + expId + '-' + m);
    if (inp) { inp.value = ''; inp.classList.remove('modified'); }
  }
  clearTimeout(_fcDebounce);
  _fcDebounce = setTimeout(fcRefreshResults, 280);
}

function fcToggleMonthlyView(id) {
  const el = document.getElementById('fc-monthgrid-' + id);
  if (!el) return;
  el.classList.toggle('open');
  const btn = document.getElementById('fc-expandbtn-' + id);
  if (btn) {
    const open = el.classList.contains('open');
    btn.textContent = open ? 'â–² Monthly Plan' : 'â–¼ Monthly Plan';
    btn.style.color = open ? '#22d47e' : '#5c7cff';
    btn.style.borderColor = open ? 'rgba(34,212,126,0.3)' : 'rgba(92,124,255,0.25)';
    btn.style.background = open ? 'rgba(34,212,126,0.08)' : 'rgba(92,124,255,0.1)';
  }
}

// â”€â”€ Monthly grid renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fcRenderDebtMonthlyGrid(d, MONTHS, fcStart) {
  fcMigrateState();
  const pData = state.forecast.debtPayments[d.id] || { default: d.minPayment, months: {} };
  const def = typeof pData === 'object' ? (pData.default !== undefined ? pData.default : d.minPayment) : pData;
  const overrides = (typeof pData === 'object' && pData.months) ? pData.months : {};

  const headers = Array.from({ length: MONTHS }, (_, i) =>
    `<th>${fmtMonthLabel(addMonths(fcStart, i))}</th>`
  ).join('');

  const paymentCells = Array.from({ length: MONTHS }, (_, i) => {
    const ov = overrides[String(i)];
    const hasOv = ov !== undefined;
    return `<td><input type="number" class="fc-month-input${hasOv ? ' modified' : ''}" id="fc-mi-${d.id}-${i}" value="${hasOv ? ov : ''}" placeholder="${def !== undefined ? def : d.minPayment}" min="0" oninput="fcDebtMonthChange('${d.id}',${i},this.value)"></td>`;
  }).join('');

  const balCells = Array.from({ length: MONTHS }, (_, i) =>
    `<td class="fc-month-stat" id="fc-bal-${d.id}-${i}">â€”</td>`
  ).join('');
  const intCells = Array.from({ length: MONTHS }, (_, i) =>
    `<td class="fc-month-stat" id="fc-int-${d.id}-${i}">â€”</td>`
  ).join('');

  return `<div class="fc-grid-actions">
    <span style="font-size:11px;color:#6b7299;">Leave blank to use default (<span style="color:#eef0f8;">${fmt(def)}/mo</span>). Type to override specific months.</span>
    <button class="fc-grid-action-btn" onclick="fcFillAllDebtMonths('${d.id}')">Fill all from default</button>
    <button class="fc-grid-action-btn muted" onclick="fcClearDebtMonths('${d.id}')">Clear overrides</button>
  </div>
  <div class="fc-months-scroll">
    <table class="fc-month-table">
      <thead><tr><th>Metric</th>${headers}</tr></thead>
      <tbody>
        <tr><td style="color:#eef0f8;font-weight:700;">Payment ($)</td>${paymentCells}</tr>
        <tr><td>Balance After</td>${balCells}</tr>
        <tr><td>Interest</td>${intCells}</tr>
      </tbody>
    </table>
  </div>`;
}

function fcRenderExpenseMonthlyGrid(e, MONTHS, fcStart) {
  fcMigrateState();
  const pData = state.forecast.expensePlanned?.[e.id] || { default: e.amount, months: {} };
  const def = typeof pData === 'object' ? (pData.default !== undefined ? pData.default : e.amount) : pData;
  const overrides = (typeof pData === 'object' && pData.months) ? pData.months : {};

  const headers = Array.from({ length: MONTHS }, (_, i) =>
    `<th>${fmtMonthLabel(addMonths(fcStart, i))}</th>`
  ).join('');

  const amtCells = Array.from({ length: MONTHS }, (_, i) => {
    const ov = overrides[String(i)];
    const hasOv = ov !== undefined;
    return `<td><input type="number" class="fc-month-input${hasOv ? ' modified' : ''}" id="fc-ei-${e.id}-${i}" value="${hasOv ? ov : ''}" placeholder="${def !== undefined ? def : e.amount}" min="0" oninput="fcExpenseMonthChange('${e.id}',${i},this.value)"></td>`;
  }).join('');

  return `<div class="fc-grid-actions">
    <span style="font-size:11px;color:#6b7299;">Leave blank to use default (<span style="color:#eef0f8;">${fmt(def)}/mo</span>). Override any month below.</span>
    <button class="fc-grid-action-btn muted" onclick="fcClearExpenseMonths('${e.id}')">Clear overrides</button>
  </div>
  <div class="fc-months-scroll">
    <table class="fc-month-table">
      <thead><tr><th>Amount</th>${headers}</tr></thead>
      <tbody><tr><td style="color:#eef0f8;font-weight:700;">Planned ($)</td>${amtCells}</tr></tbody>
    </table>
  </div>`;
}

function fcRenderGoalMonthlyGrid(g, MONTHS, fcStart) {
  fcMigrateState();
  const pData = state.forecast.goalContributions[g.id] || { default: 0, months: {} };
  const def = typeof pData === 'object' ? (pData.default !== undefined ? pData.default : 0) : pData;
  const overrides = (typeof pData === 'object' && pData.months) ? pData.months : {};

  const headers = Array.from({ length: MONTHS }, (_, i) =>
    `<th>${fmtMonthLabel(addMonths(fcStart, i))}</th>`
  ).join('');

  const cells = Array.from({ length: MONTHS }, (_, i) => {
    const ov = overrides[String(i)];
    const hasOv = ov !== undefined;
    return `<td><input type="number" class="fc-month-input${hasOv ? ' modified' : ''}" id="fc-gi-${g.id}-${i}" value="${hasOv ? ov : ''}" placeholder="${def}" min="0" oninput="fcGoalMonthChange('${g.id}',${i},this.value)"></td>`;
  }).join('');

  return `<div class="fc-grid-actions">
    <span style="font-size:11px;color:#6b7299;">Leave blank to use default (<span style="color:#eef0f8;">${fmt(def)}/mo</span>). Override specific months below.</span>
    <button class="fc-grid-action-btn muted" onclick="fcClearGoalMonths('${g.id}')">Clear overrides</button>
  </div>
  <div class="fc-months-scroll">
    <table class="fc-month-table">
      <thead><tr><th>Amount</th>${headers}</tr></thead>
      <tbody><tr><td style="color:#eef0f8;font-weight:700;">Contribution ($)</td>${cells}</tr></tbody>
    </table>
  </div>`;
}

function fcRenderGeneralSavingsGrid(MONTHS, fcStart) {
  const def = typeof state.forecast.generalSavings === 'number' ? state.forecast.generalSavings : 0;
  const overrides = state.forecast.generalSavingsMonths || {};

  const headers = Array.from({ length: MONTHS }, (_, i) =>
    `<th>${fmtMonthLabel(addMonths(fcStart, i))}</th>`
  ).join('');

  const cells = Array.from({ length: MONTHS }, (_, i) => {
    const ov = overrides[String(i)];
    const hasOv = ov !== undefined;
    return `<td><input type="number" class="fc-month-input${hasOv ? ' modified' : ''}" id="fc-gsi-${i}" value="${hasOv ? ov : ''}" placeholder="${def}" min="0" oninput="fcGeneralSavingsMonthChange(${i},this.value)"></td>`;
  }).join('');

  return `<div class="fc-grid-actions">
    <span style="font-size:11px;color:#6b7299;">Leave blank to use default (<span style="color:#eef0f8;">${fmt(def)}/mo</span>). Override specific months below.</span>
    <button class="fc-grid-action-btn muted" onclick="fcClearGeneralSavingsMonths()">Clear overrides</button>
  </div>
  <div class="fc-months-scroll">
    <table class="fc-month-table">
      <thead><tr><th>Amount</th>${headers}</tr></thead>
      <tbody><tr><td style="color:#eef0f8;font-weight:700;">Savings ($)</td>${cells}</tr></tbody>
    </table>
  </div>`;
}

function fcUpdateMonthlyGrids(debtMonthlyData, MONTHS) {
  for (const [debtId, arr] of Object.entries(debtMonthlyData)) {
    for (let m = 0; m < Math.min(MONTHS, arr.length); m++) {
      const { payment, interest, balanceAfter } = arr[m];
      const balEl = document.getElementById('fc-bal-' + debtId + '-' + m);
      const intEl = document.getElementById('fc-int-' + debtId + '-' + m);
      if (balEl) {
        balEl.textContent = balanceAfter <= 0.01 ? 'âœ“ Paid off' : fmtK(balanceAfter);
        balEl.style.color = balanceAfter <= 0.01 ? '#22d47e' : '#ff5b6b';
      }
      if (intEl) {
        intEl.textContent = interest < 0.01 ? '$0' : fmtK(interest);
        intEl.style.color = interest > 50 ? '#ff9f43' : '#6b7299';
      }
    }
  }
}

function renderFcExpensePlanner(MONTHS, fcStart) {
  const epEl = document.getElementById('fcExpensePlanner');
  if (!epEl) return;
  fcMigrateState();
  if (state.expenses.length === 0) {
    epEl.innerHTML = `<div class="empty"><div class="empty-icon">ðŸ“‹</div><div class="empty-text">No expenses added yet. Go to Cash Flow to add expenses, then plan them here.</div></div>`;
    return;
  }
  epEl.innerHTML = state.expenses.map(e => {
    const pData = state.forecast.expensePlanned[e.id];
    const def = (typeof pData === 'object' && pData) ? (pData.default !== undefined ? pData.default : e.amount) : (typeof pData === 'number' ? pData : e.amount);
    const hasOverrides = typeof pData === 'object' && pData?.months && Object.keys(pData.months).length > 0;
    const inputVal = (def !== e.amount) ? def : '';
    return `<div class="fc-expense-container">
      <div class="fc-expense-row">
        <div class="fc-planner-name">
          <div style="font-size:20px;line-height:1;">${getCategoryEmoji(e.category)}</div>
          <div>
            <div style="font-size:13px;font-weight:700;">${e.name}</div>
            <div style="font-size:10px;color:#6b7299;font-family:'DM Mono',monospace;">${e.category || 'expense'}</div>
          </div>
        </div>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:13px;color:#6b7299;">${fmt(e.amount)}</div>
          <div style="font-size:10px;color:#6b7299;">from Cash Flow</div>
        </div>
        <div>
          <div class="fc-input-wrap">
            <span class="fc-input-label">$</span>
            <input type="number" class="fc-payment-input" value="${inputVal}" placeholder="${e.amount}" min="0" oninput="fcExpenseDefaultChange('${e.id}', this.value)">
            <span class="fc-input-label">/mo</span>
          </div>
          ${hasOverrides ? `<div style="font-size:10px;color:#5c7cff;margin-top:3px;font-family:'DM Mono',monospace;">Has monthly variations</div>` : ''}
        </div>
        <div>
          <div style="font-size:13px;font-weight:700;color:#eef0f8;">${fmtK(def * MONTHS)}</div>
          <div style="font-size:10px;color:#6b7299;">over ${MONTHS} months</div>
        </div>
      </div>
      <div class="fc-expand-row">
        <button class="fc-expand-btn" id="fc-expandbtn-exp-${e.id}" onclick="fcToggleMonthlyView('exp-${e.id}')">â–¼ Plan by Month</button>
      </div>
      <div class="fc-monthly-grid" id="fc-monthgrid-exp-${e.id}">
        ${fcRenderExpenseMonthlyGrid(e, MONTHS, fcStart)}
      </div>
    </div>`;
  }).join('');
}

function _fcUpdateDebtRow(debtId, payment) {
  const d = state.debts.find(x => x.id === debtId);
  if (!d) return;
  const mo = monthsToPayoff(d.balance, d.apr, payment);
  const interest = totalInterest(d.balance, d.apr, payment);
  const payoffEl = document.getElementById('fc-payoff-' + debtId);
  const interestEl = document.getElementById('fc-interest-' + debtId);
  const warnEl = document.getElementById('fc-warn-' + debtId);
  if (payoffEl) {
    if (payment <= 0) { payoffEl.textContent = 'No payment'; payoffEl.style.color = '#6b7299'; }
    else if (!isFinite(mo)) { payoffEl.textContent = 'Never âš '; payoffEl.style.color = '#ff5b6b'; }
    else {
      const _d = new Date(); const _fs = new Date(_d.getFullYear(), _d.getMonth() + 1, 1);
      payoffEl.textContent = addMonths(_fs, mo).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      payoffEl.style.color = mo <= 12 ? '#22d47e' : mo <= 36 ? '#eef0f8' : '#6b7299';
    }
  }
  if (interestEl) {
    interestEl.textContent = isFinite(interest) && interest >= 0 ? fmtK(interest) : 'â€”';
    interestEl.style.color = interest > 5000 ? '#ff5b6b' : interest > 500 ? '#ff9f43' : '#22d47e';
  }
  if (warnEl) {
    warnEl.textContent = (payment > 0 && payment < d.minPayment) ? 'âš  Below minimum' : '';
  }
  // Update payoff span in the forecast table subtitle
  const tblPayoffEl = document.getElementById('fc-tbl-payoff-' + debtId);
  if (tblPayoffEl) {
    if (payment <= 0) { tblPayoffEl.textContent = 'No payment'; }
    else if (!isFinite(mo)) { tblPayoffEl.textContent = 'âš  Won\'t pay off'; }
    else {
      const _d = new Date(); const _fs = new Date(_d.getFullYear(), _d.getMonth() + 1, 1);
      tblPayoffEl.textContent = addMonths(_fs, mo).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }
  }
}

function _fcUpdateGoalRow(goalId, monthly) {
  const g = state.goals.find(x => x.id === goalId);
  if (!g) return;
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  const needed = Math.max(0, g.target - g.saved);
  const moToReach = monthly > 0 ? Math.ceil(needed / monthly) : Infinity;
  const reachEl = document.getElementById('fc-greach-' + goalId);
  const projEl = document.getElementById('fc-gproj-' + goalId);
  if (reachEl) {
    if (!isFinite(moToReach)) { reachEl.textContent = 'Add more'; reachEl.style.color = '#6b7299'; }
    else { const _d = new Date(); const _fs = new Date(_d.getFullYear(), _d.getMonth() + 1, 1); reachEl.textContent = addMonths(_fs, moToReach).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }); reachEl.style.color = moToReach <= MONTHS ? '#22d47e' : '#ff9f43'; }
  }
  if (projEl) { projEl.style.width = Math.min(100, ((g.saved + monthly * MONTHS) / g.target * 100)).toFixed(1) + '%'; }
}

// â”€â”€ Smart Plan (Avalanche Algorithm) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateSmartPlan() {
  fcMigrateState();
  const income = getMonthlyIncome();
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  const includedDebts = state.debts.filter(d => d.included);
  if (includedDebts.length === 0) { showToast('No debts to plan â€” add debt accounts first.', 'warn'); return; }

  const fixedExpenses = state.expenses.reduce((s, e) => {
    const p = state.forecast.expensePlanned?.[e.id];
    const def = (typeof p === 'object' && p) ? (p.default !== undefined ? p.default : e.amount) : (typeof p === 'number' ? p : e.amount);
    return s + def;
  }, 0);
  const goalSavings = state.goals.reduce((s, g) => {
    const p = state.forecast.goalContributions?.[g.id];
    const def = typeof p === 'object' ? (p?.default || 0) : (p || 0);
    return s + def;
  }, 0);
  const genSavings = typeof state.forecast.generalSavings === 'number' ? state.forecast.generalSavings : 0;
  const fixedSavings = goalSavings + genSavings;
  const totalMin = includedDebts.reduce((s, d) => s + d.minPayment, 0);
  const availableBudget = income - fixedExpenses - fixedSavings;

  if (availableBudget <= totalMin) {
    showToast('Not enough surplus to apply smart plan â€” income may be too low.', 'warn');
    return;
  }

  // Avalanche: sort by APR descending, cascade surplus to highest-APR debt
  let simDebts = includedDebts.map(d => ({ id: d.id, balance: d.balance, apr: d.apr, minPayment: d.minPayment, name: d.name }));
  // Initialize per-month payment storage
  const planPayments = {};
  for (const d of simDebts) { planPayments[d.id] = {}; }

  for (let m = 0; m < MONTHS; m++) {
    // Remaining debts still owed
    const activeDebts = simDebts.filter(d => d.balance > 0.01);
    if (activeDebts.length === 0) break;

    // Sort by APR descending for avalanche
    activeDebts.sort((a, b) => b.apr - a.apr);

    let remaining = availableBudget;

    // Assign minimums to all active debts first
    const payments = {};
    for (const d of activeDebts) {
      const pmt = Math.min(d.minPayment, d.balance + d.balance * d.apr / 100 / 12);
      payments[d.id] = pmt;
      remaining -= pmt;
    }

    // Cascade remaining surplus to highest-APR debt
    for (const d of activeDebts) {
      if (remaining <= 0.005) break;
      const interest = d.balance * d.apr / 100 / 12;
      const balWithInt = d.balance + interest;
      const extra = Math.min(remaining, balWithInt - payments[d.id]);
      if (extra > 0) {
        payments[d.id] += extra;
        remaining -= extra;
      }
    }

    // Simulate balances
    for (const d of simDebts) {
      if (d.balance <= 0.01) { planPayments[d.id][String(m)] = 0; continue; }
      const interest = d.balance * d.apr / 100 / 12;
      const balWithInt = d.balance + interest;
      const pmt = Math.min(payments[d.id] || d.minPayment, balWithInt);
      planPayments[d.id][String(m)] = Math.round(pmt * 100) / 100;
      d.balance = Math.max(0, balWithInt - pmt);
    }
  }

  // Apply to state (clear existing overrides and set smart plan months)
  for (const d of includedDebts) {
    const months = planPayments[d.id];
    state.forecast.debtPayments[d.id] = { default: d.minPayment, months };
  }
  saveToStorage();
  renderForecast();
  showToast('Smart Plan applied â€” avalanche method (highest APR first)', 'success');
}

function showToast(msg, type) {
  let t = document.getElementById('fcToast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'fcToast';
    t.style.cssText = 'position:fixed;bottom:28px;left:50%;transform:translateX(-50%);padding:10px 22px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transition:opacity .3s;pointer-events:none;font-family:"DM Sans",sans-serif;';
    document.body.appendChild(t);
  }
  const colors = { success: { bg: 'rgba(34,212,126,0.15)', border: '#22d47e', color: '#22d47e' }, warn: { bg: 'rgba(255,159,67,0.15)', border: '#ff9f43', color: '#ff9f43' }, error: { bg: 'rgba(255,91,107,0.15)', border: '#ff5b6b', color: '#ff5b6b' } };
  const c = colors[type] || colors.success;
  t.style.background = c.bg;
  t.style.border = '1px solid ' + c.border;
  t.style.color = c.color;
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.style.opacity = '0'; }, 3500);
}

function fcClearSmartPlan() {
  fcMigrateState();
  for (const d of state.debts.filter(d => d.included)) {
    state.forecast.debtPayments[d.id] = { default: d.minPayment, months: {} };
  }
  saveToStorage();
  renderForecast();
  showToast('Smart Plan cleared â€” back to defaults', 'warn');
}

function fcRefreshResults() {
  const income = getMonthlyIncome();
  const now = new Date();
  const fcStart = new Date(now.getFullYear(), now.getMonth() + 1, 1);
  const MONTHS = parseInt(document.getElementById('fcMonths')?.value) || 36;
  fcMigrateState();
  if (!state.forecast.goalContributions) state.forecast.goalContributions = {};

  const includedDebts = state.debts.filter(d => d.included);

  // Per-month simulation
  let simDebts = includedDebts.map(d => ({ ...d }));
  let simBaseline = includedDebts.map(d => ({ ...d }));
  const debtMonthlyData = {};
  const debtPayoffMonths = {};
  for (const d of includedDebts) { debtMonthlyData[d.id] = []; debtPayoffMonths[d.id] = null; }

  const perMonth = [];
  const totalDebtData = [], savingsAccumData = [], baselineData = [];
  let cumSavings = 0;

  for (let m = 0; m < MONTHS; m++) {
    // Baseline (minimums only)
    for (const d of simBaseline) {
      if (d.balance <= 0) continue;
      d.balance = Math.max(0, d.balance + d.balance * d.apr / 100 / 12 - d.minPayment);
    }
    baselineData.push(simBaseline.reduce((s, d) => s + d.balance, 0));

    // Planned expenses for this month
    const fixedExp = state.expenses.reduce((s, e) => s + getPlannedExpenseAmount(e.id, m), 0);

    // Per-month savings (goals + general, each may vary)
    const monthGoalSavings = state.goals.reduce((s, g) => s + getPlannedGoalContrib(g.id, m), 0);
    const monthGenSavings = getPlannedGeneralSavings(m);
    const monthlySavings = monthGoalSavings + monthGenSavings;

    // Plan simulation: apply interest then payment per debt
    let monthDebtTotal = 0;
    for (const sd of simDebts) {
      if (sd.balance <= 0) {
        debtMonthlyData[sd.id].push({ payment: 0, interest: 0, balanceAfter: 0 });
        continue;
      }
      const interest = sd.balance * sd.apr / 100 / 12;
      const balWithInt = sd.balance + interest;
      const planned = getPlannedDebtPayment(sd.id, m);
      const pmt = Math.min(planned, balWithInt);
      sd.balance = Math.max(0, balWithInt - pmt);
      monthDebtTotal += pmt;
      debtMonthlyData[sd.id].push({ payment: pmt, interest, balanceAfter: sd.balance });
      if (debtPayoffMonths[sd.id] === null && sd.balance <= 0.01) debtPayoffMonths[sd.id] = m + 1;
    }

    const monthIncome = getPlannedIncome(m);
    const surplus = monthIncome - fixedExp - monthDebtTotal - monthlySavings;
    totalDebtData.push(simDebts.reduce((s, d) => s + d.balance, 0));
    cumSavings += monthlySavings;
    savingsAccumData.push(cumSavings);
    perMonth.push({ income: monthIncome, fixedExp, debtPmt: monthDebtTotal, savings: monthlySavings, surplus });
  }

  // Per-debt balance-over-time arrays for debt progress chart
  const debtProgressSeries = includedDebts.map(d => ({
    id: d.id, name: d.name, color: d.color,
    data: debtMonthlyData[d.id].map(m => m.balanceAfter)
  }));

  // Update the forecast spreadsheet table with calculated values
  updateForecastTableCalcs(perMonth, debtMonthlyData, totalDebtData, MONTHS);

  const interestSaved = Math.max(0, (baselineData[MONTHS-1]||0) - (totalDebtData[MONTHS-1]||0));

  const baseIncome = getMonthlyIncome();
  // Budget bar â€” use month-1 values
  const m0 = perMonth[0] || { income: baseIncome, fixedExp: getMonthlyExpenses(), debtPmt: 0, savings: 0, surplus: 0 };
  const totalOut0 = m0.fixedExp + m0.debtPmt + m0.savings;
  const surplus0 = m0.income - totalOut0;
  const segs = [
    { label: 'Expenses', amount: m0.fixedExp, color: '#ff5b6b' },
    { label: 'Debt Payments', amount: m0.debtPmt, color: '#ff9f43' },
    { label: 'Savings', amount: m0.savings, color: '#22d47e' },
    { label: surplus0 >= 0 ? 'Unallocated' : 'Over Budget', amount: Math.abs(surplus0), color: surplus0 >= 0 ? '#5c7cff' : 'rgba(255,91,107,0.5)' }
  ].filter(s => s.amount > 0.01);
  const barTotal = Math.max(m0.income, totalOut0, 1);
  const barEl = document.getElementById('fcBudgetBar');
  const legEl = document.getElementById('fcBudgetLegend');
  const tagEl = document.getElementById('fcSurplusTag');
  if (barEl) barEl.innerHTML = segs.map(s => `<div style="width:${(s.amount/barTotal*100).toFixed(1)}%;background:${s.color};height:100%;" title="${s.label}: ${fmtK(s.amount)}"></div>`).join('');
  if (legEl) legEl.innerHTML = `<div class="fc-legend-item"><span class="fc-budget-dot" style="background:#6b7299"></span>Income:&nbsp;<span style="color:#22d47e;">${fmtK(m0.income)}/mo</span></div>${segs.map(s=>`<div class="fc-legend-item"><span class="fc-budget-dot" style="background:${s.color}"></span>${s.label}:&nbsp;<span>${fmtK(s.amount)}</span></div>`).join('')}`;
  if (tagEl) { tagEl.textContent = surplus0 >= 0 ? `+${fmtK(surplus0)} free` : `${fmtK(Math.abs(surplus0))} over`; tagEl.style.cssText = `background:${surplus0>=0?'rgba(34,212,126,0.15)':'rgba(255,91,107,0.15)'};color:${surplus0>=0?'#22d47e':'#ff5b6b'};font-size:11px;font-weight:700;font-family:'DM Mono',monospace;padding:4px 12px;border-radius:99px;`; }

  // Debt-free estimate
  let debtFreeLabel = 'â€”';
  for (let i = 0; i < totalDebtData.length; i++) {
    if (totalDebtData[i] <= 0.01) { debtFreeLabel = addMonths(fcStart, i).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }); break; }
  }

  // Average monthly surplus for KPI
  const avgSurplus = perMonth.length ? perMonth.reduce((s, m) => s + m.surplus, 0) / perMonth.length : surplus0;

  // KPIs
  document.getElementById('fcKpiSavings').textContent = fmt(savingsAccumData[MONTHS-1]||0);
  document.getElementById('fcKpiSavingsSub').textContent = 'over ' + MONTHS + ' months';
  document.getElementById('fcKpiDebtFree').textContent = debtFreeLabel;
  const surplusKpi = document.getElementById('fcKpiSurplus');
  surplusKpi.textContent = (surplus0 < 0 ? '-' : '') + fmt(Math.abs(surplus0));
  surplusKpi.className = 'kpi-value ' + (surplus0 >= 0 ? 'green' : 'red');
  document.getElementById('fcKpiSurplusSub').textContent = surplus0 >= 0 ? 'month 1 Â· income minus all planned spending' : 'over budget month 1 â€” reduce somewhere';
  document.getElementById('fcKpiSurplusCard').className = 'kpi ' + (surplus0 >= 0 ? 'green' : 'red');
  document.getElementById('fcKpiInterestSaved').textContent = fmt(interestSaved);

  // â”€â”€ New Stacked Bar Chart: Income up, Expenses down, Surplus colored â”€â”€
  destroyChart('forecast');
  const ctx = document.getElementById('forecastChart')?.getContext('2d');
  if (ctx) {
    const labels = Array.from({ length: MONTHS }, (_, i) => fmtMonthLabel(addMonths(fcStart, i)));
    const incomeArr   = perMonth.map(d => d.income);
    const expenseArr  = perMonth.map(d => -(d.fixedExp));
    const debtArr     = perMonth.map(d => -(d.debtPmt));
    const savingsArr  = perMonth.map(d => -(d.savings));
    const surplusArr  = perMonth.map(d => d.surplus);
    const surplusColors = surplusArr.map(v => v >= 0 ? 'rgba(34,212,126,0.75)' : 'rgba(255,91,107,0.75)');
    const surplusBorder = surplusArr.map(v => v >= 0 ? '#22d47e' : '#ff5b6b');

    charts['forecast'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Income',        data: incomeArr,   backgroundColor: 'rgba(34,212,126,0.75)',  borderColor: '#22d47e',  borderWidth: 0, stack: 'pos' },
          { label: 'Expenses',      data: expenseArr,  backgroundColor: 'rgba(255,91,107,0.75)',  borderColor: '#ff5b6b',  borderWidth: 0, stack: 'neg' },
          { label: 'Debt Payments', data: debtArr,     backgroundColor: 'rgba(255,159,67,0.75)',  borderColor: '#ff9f43',  borderWidth: 0, stack: 'neg' },
          { label: 'Savings',       data: savingsArr,  backgroundColor: 'rgba(92,124,255,0.75)',  borderColor: '#5c7cff',  borderWidth: 0, stack: 'neg' },
          { label: 'Surplus',       data: surplusArr,  backgroundColor: surplusColors, borderColor: surplusBorder, borderWidth: 1, stack: 'surp' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { color: '#6b7299', font: { size: 11 }, usePointStyle: true, pointStyleWidth: 10 } },
          tooltip: {
            callbacks: {
              label: c => {
                const v = c.raw;
                return ` ${c.dataset.label}: ${v < 0 ? '-' : ''}${fmtK(Math.abs(v))}`;
              }
            }
          }
        },
        scales: {
          x: { stacked: true, grid: { display: false }, ticks: { maxTicksLimit: 12, color: '#6b7299' } },
          y: { stacked: true, ticks: { callback: v => fmtK(v), color: '#6b7299' }, grid: { color: 'rgba(255,255,255,0.04)' },
               title: { display: true, text: 'â† Outflows  |  Income â†’', color: '#6b7299', font: { size: 10 } } }
        }
      }
    });
  }

  // â”€â”€ Debt Paydown Progress chart â”€â”€
  destroyChart('debtProgress');
  const ctxDP = document.getElementById('debtProgressChart')?.getContext('2d');
  if (ctxDP) {
    const labels = Array.from({ length: MONTHS }, (_, i) => fmtMonthLabel(addMonths(fcStart, i)));
    const datasets = [];
    if (debtProgressSeries.length > 0) {
      // Individual debt lines
      for (const ds of debtProgressSeries) {
        datasets.push({
          label: ds.name, data: ds.data,
          borderColor: ds.color, backgroundColor: ds.color + '18',
          borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false
        });
      }
      // Bold total line
      datasets.push({
        label: 'Total Debt', data: totalDebtData,
        borderColor: '#ff5b6b', backgroundColor: 'rgba(255,91,107,0.06)',
        borderWidth: 3, pointRadius: 0, tension: 0.3, fill: true,
        borderDash: [6, 3]
      });
    }
    charts['debtProgress'] = new Chart(ctxDP, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { color: '#6b7299', font: { size: 11 }, usePointStyle: true } },
          tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${c.raw <= 0.01 ? 'âœ“ Paid off' : fmtK(c.raw)}` } }
        },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 12, color: '#6b7299' } },
          y: { min: 0, ticks: { callback: v => fmtK(v), color: '#6b7299' }, grid: { color: 'rgba(255,255,255,0.04)' } }
        }
      }
    });
  }

  // â”€â”€ Savings & Surplus Progress chart â”€â”€
  destroyChart('savingsSurplus');
  const ctxSS = document.getElementById('savingsSurplusChart')?.getContext('2d');
  if (ctxSS) {
    const labels = Array.from({ length: MONTHS }, (_, i) => fmtMonthLabel(addMonths(fcStart, i)));
    const surplusArr2 = perMonth.map(d => d.surplus);
    const surplusColors2 = surplusArr2.map(v => v >= 0 ? 'rgba(92,124,255,0.7)' : 'rgba(255,91,107,0.7)');
    charts['savingsSurplus'] = new Chart(ctxSS, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Monthly Surplus',
            data: surplusArr2,
            backgroundColor: surplusColors2,
            borderColor: surplusArr2.map(v => v >= 0 ? '#5c7cff' : '#ff5b6b'),
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'y',
            order: 2
          },
          {
            label: 'Cumulative Savings',
            data: savingsAccumData,
            type: 'line',
            borderColor: '#22d47e',
            backgroundColor: 'rgba(34,212,126,0.08)',
            borderWidth: 2.5,
            pointRadius: 0,
            tension: 0.4,
            fill: true,
            yAxisID: 'y2',
            order: 1
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { color: '#6b7299', font: { size: 11 }, usePointStyle: true } },
          tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${fmtK(Math.abs(c.raw))}${c.raw < 0 ? ' (deficit)' : ''}` } }
        },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 12, color: '#6b7299' } },
          y: { position: 'left', ticks: { callback: v => fmtK(v), color: '#6b7299' }, grid: { color: 'rgba(255,255,255,0.04)' },
               title: { display: true, text: 'Monthly Surplus', color: '#5c7cff', font: { size: 10 } } },
          y2: { position: 'right', ticks: { callback: v => fmtK(v), color: '#22d47e' }, grid: { display: false },
                title: { display: true, text: 'Cumulative Savings', color: '#22d47e', font: { size: 10 } } }
        }
      }
    });
  }

  saveToStorage();
}

// â”€â”€ Forecast Spreadsheet Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForecastTable(MONTHS, fcStart) {
  fcMigrateState();
  const baseIncome = getMonthlyIncome();
  const includedDebts = state.debts.filter(d => d.included);
  const lbl = (text, sub, color) =>
    `<td class="fc-tbl-label"${color ? ` style="color:${color}"` : ''}><div>${text}</div>${sub ? `<div style="font-size:10px;color:#6b7299;margin-top:1px;">${sub}</div>` : ''}</td>`;
  const sec = (text) =>
    `<tr class="fc-tbl-section"><td class="fc-tbl-label" colspan="${MONTHS+3}">${text}</td></tr>`;
  const calc = id => `<td class="fc-tbl-calc" id="${id}">â€”</td>`;
  const tot  = id => `<td class="fc-tbl-calc fc-tbl-total-col" id="${id}">â€”</td>`;
  const hdrs = Array.from({length:MONTHS},(_,i)=>`<th class="fc-tbl-th fc-tbl-month">${fmtMonthLabel(addMonths(fcStart,i))}</th>`).join('');
  const defCell = (content) => `<td class="fc-tbl-default-col">${content}</td>`;
  const defInput = (val, placeholder, handler, extra='') =>
    `<input type="number" class="fc-cell-input" value="${val}" placeholder="${placeholder||'0'}" min="0" oninput="${handler}" ${extra} style="width:80px;">`;

  // Income row
  const incCells = Array.from({length:MONTHS},(_,i)=>{
    const ov=(state.forecast.incomeMonths||{})[String(i)];
    return `<td class="fc-tbl-cell"><input type="number" class="fc-cell-input${ov!==undefined?' modified':''}" value="${ov!==undefined?ov:''}" placeholder="${baseIncome}" min="0" oninput="fcIncomeMonthChange(${i},this.value,this)" title="Override income for ${fmtMonthLabel(addMonths(fcStart,i))}. Blank = ${fmt(baseIncome)} from Cash Flow."></td>`;
  }).join('');

  // Expense rows
  const expRows = state.expenses.map(e=>{
    const p=state.forecast.expensePlanned?.[e.id];
    const def=(typeof p==='object'&&p)?(p.default??e.amount):(typeof p==='number'?p:e.amount);
    const cells=Array.from({length:MONTHS},(_,i)=>{
      const ov=(typeof p==='object'&&p?.months)?.[String(i)];
      return `<td class="fc-tbl-cell"><input type="number" class="fc-cell-input${ov!==undefined?' modified':''}" value="${ov!==undefined?ov:''}" placeholder="${def}" min="0" data-exp-id="${e.id}" oninput="fcExpenseMonthChange('${e.id}',${i},this.value,this)"></td>`;
    }).join('');
    const dInp=defInput(def,'','fcExpenseDefaultChange(\''+e.id+'\',this.value)',`title="Default for all months â€” override individual cells to vary"`);
    return `<tr class="fc-tbl-row-expense">${lbl(e.name,e.category,'#ff5b6b')}${defCell(dInp)}${cells}${tot('fc-tbl-exp-tot-'+e.id)}</tr>`;
  }).join('');

  // Debt rows (payment + balance + interest sub-rows)
  const debtRows = includedDebts.map(d=>{
    const p=state.forecast.debtPayments?.[d.id];
    const def=typeof p==='object'?(p?.default??d.minPayment):(p||d.minPayment);
    const pmtCells=Array.from({length:MONTHS},(_,i)=>{
      const ov=(typeof p==='object'&&p?.months)?.[String(i)];
      return `<td class="fc-tbl-cell"><input type="number" class="fc-cell-input${ov!==undefined?' modified':''}" value="${ov!==undefined?ov:''}" placeholder="${def}" min="0" data-debt-id="${d.id}" oninput="fcDebtMonthChange('${d.id}',${i},this.value,this)" title="${d.name} â€” Min ${fmt(d.minPayment)}/mo"></td>`;
    }).join('');
    const balCells=Array.from({length:MONTHS},(_,i)=>calc(`fc-tbl-bal-${d.id}-${i}`)).join('');
    const intCells=Array.from({length:MONTHS},(_,i)=>calc(`fc-tbl-int-${d.id}-${i}`)).join('');
    const dot=`<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${d.color};margin-right:5px;vertical-align:middle;"></span>`;
    const dInp=defInput(def,d.minPayment,'fcDebtInputChange(\''+d.id+'\',this.value)',`title="Default payment â€” min is ${fmt(d.minPayment)}/mo"`);
    const payoffMos=monthsToPayoff(d.balance,d.apr,def);
    let payoffStr;
    if(payoffMos===0) payoffStr='âœ“ Paid off';
    else if(!isFinite(payoffMos)) payoffStr='âš  Won\'t pay off';
    else { const pd=addMonths(fcStart,payoffMos); payoffStr=pd.toLocaleDateString('en-US',{month:'short',year:'numeric'}); }
    const inpS=`background:transparent;border:none;border-bottom:1px solid rgba(107,114,153,0.45);color:#c8cde8;font-size:10px;font-family:'DM Mono',monospace;padding:0 2px;outline:none;`;
    const subStyle=`font-size:10px;color:#6b7299;margin-top:2px;`;
    const lblCell=`<td class="fc-tbl-label" style="color:#ff9f43"><div>${dot}${d.name}</div>`
      +`<div style="${subStyle}">Balance: <input type="number" id="fc-tbl-balinp-${d.id}" value="${d.balance}" style="${inpS}width:78px;" onchange="fcTblBalanceChange('${d.id}',this.value)" title="Edit current balance â€” syncs to Cash Flow"></div>`
      +`<div style="${subStyle}"><input type="number" id="fc-tbl-aprinp-${d.id}" value="${d.apr}" style="${inpS}width:36px;" onchange="fcTblAprChange('${d.id}',this.value)" title="Edit APR â€” syncs to Cash Flow">% APR Â· Min ${fmt(d.minPayment)}/mo</div>`
      +`<div style="${subStyle}">Est. payoff: <span id="fc-tbl-payoff-${d.id}">${payoffStr}</span></div></td>`;
    return `<tr class="fc-tbl-row-debt">${lblCell}${defCell(dInp)}${pmtCells}${tot('fc-tbl-pmt-tot-'+d.id)}</tr>
    <tr class="fc-tbl-row-debt-bal">${lbl('â”” Balance after','','')}${defCell('&nbsp;')}${balCells}${tot('fc-tbl-bal-fin-'+d.id)}</tr>
    <tr class="fc-tbl-row-debt-int">${lbl('â”” Interest charged','','')}${defCell('&nbsp;')}${intCells}${tot('fc-tbl-int-tot-'+d.id)}</tr>`;
  }).join('');

  // Savings rows
  const savRows = state.goals.map(g=>{
    const p=state.forecast.goalContributions?.[g.id];
    const def=typeof p==='object'?(p?.default||0):(p||0);
    const cells=Array.from({length:MONTHS},(_,i)=>{
      const ov=(typeof p==='object'&&p?.months)?.[String(i)];
      return `<td class="fc-tbl-cell"><input type="number" class="fc-cell-input${ov!==undefined?' modified':''}" value="${ov!==undefined?ov:''}" placeholder="${def}" min="0" data-goal-id="${g.id}" oninput="fcGoalMonthChange('${g.id}',${i},this.value,this)"></td>`;
    }).join('');
    const dInp=defInput(def,'0','fcGoalInputChange(\''+g.id+'\',this.value)',`title="Monthly contribution default"`);
    return `<tr class="fc-tbl-row-savings">${lbl((g.emoji||'ðŸŽ¯')+' '+g.name,'Goal: '+fmt(g.target),'#38bdf8')}${defCell(dInp)}${cells}${tot('fc-tbl-goal-tot-'+g.id)}</tr>`;
  }).join('');
  const genDef=typeof state.forecast.generalSavings==='number'?state.forecast.generalSavings:0;
  const genCells=Array.from({length:MONTHS},(_,i)=>{
    const ov=(state.forecast.generalSavingsMonths||{})[String(i)];
    return `<td class="fc-tbl-cell"><input type="number" class="fc-cell-input${ov!==undefined?' modified':''}" value="${ov!==undefined?ov:''}" placeholder="${genDef||'0'}" min="0" data-gensav="1" oninput="fcGeneralSavingsMonthChange(${i},this.value,this)"></td>`;
  }).join('');

  // Totals rows (calculated) â€” empty cell for default col
  const row=(cls,id,sub,col)=>`<tr class="fc-tbl-row-${cls}">${lbl(id,sub,col)}${defCell('')}${Array.from({length:MONTHS},(_,i)=>calc(`fc-tbl-${cls}-${i}`)).join('')}${tot('fc-tbl-'+cls+'-tot')}</tr>`;

  return `<table class="fc-master-table">
    <thead><tr>
      <th class="fc-tbl-label fc-tbl-th" style="text-align:left;">Category</th>
      <th class="fc-tbl-th fc-tbl-default-col">Default /mo</th>${hdrs}
      <th class="fc-tbl-th fc-tbl-total-col">Total / Final</th>
    </tr></thead>
    <tbody>
      ${sec('ðŸ’š INCOME')}
      <tr class="fc-tbl-row-income">${lbl('Monthly Income','Edit cells to override per-month income','#22d47e')}${defCell(`<span style="font-family:'DM Mono',monospace;font-size:11px;color:#6b7299;" title="Set on Cash Flow page">${fmt(baseIncome)}</span>`)}${incCells}${tot('fc-tbl-inc-tot')}</tr>
      ${state.expenses.length?sec('ðŸ”´ FIXED EXPENSES'):''}${expRows}
      ${includedDebts.length?sec('ðŸŸ  DEBT PAYMENTS'):''}${debtRows}
      ${(state.goals.length||genDef>0)?sec('ðŸ”µ SAVINGS'):''}
      ${savRows}
      <tr class="fc-tbl-row-savings">${lbl('ðŸ’° General Savings','Not tied to a goal','#38bdf8')}${defCell(defInput(genDef||'','0','fcSavingsInputChange(this.value)'))}${genCells}${tot('fc-tbl-gensav-tot')}</tr>
      ${sec('ðŸ“Š TOTALS & RUNNING BALANCE')}
      <tr class="fc-tbl-row-total-out">${lbl('Total Outflow','Expenses + Debt Pmts + Savings','#ff5b6b')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-out-'+i)).join('')}${tot('fc-tbl-out-tot')}</tr>
      <tr class="fc-tbl-row-surplus">${lbl('Monthly Surplus','Income âˆ’ Total Outflow','#eef0f8')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-surp-'+i)).join('')}${tot('fc-tbl-surp-tot')}</tr>
      <tr class="fc-tbl-row-cumul">${lbl('Cumulative Net','Running surplus / deficit','#5c7cff')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-cumul-'+i)).join('')}${tot('fc-tbl-cumul-tot')}</tr>
      <tr class="fc-tbl-row-debt-remaining">${lbl('Total Debt Remaining','All accounts combined','#ff9f43')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-totdebt-'+i)).join('')}${tot('fc-tbl-totdebt-fin')}</tr>
      <tr class="fc-tbl-row-cum-inc">${lbl('Cumul. Income','Running income total','#22d47e')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-cuminc-'+i)).join('')}${tot('fc-tbl-cuminc-tot')}</tr>
      <tr class="fc-tbl-row-cum-exp">${lbl('Cumul. Outflow','Running spending total','#ff5b6b')}${Array.from({length:MONTHS},(_,i)=>calc('fc-tbl-cumexp-'+i)).join('')}${tot('fc-tbl-cumexp-tot')}</tr>
    </tbody></table>`;
}

function updateForecastTableCalcs(perMonth, debtMonthlyData, totalDebtData, MONTHS) {
  const s=(id,t,c)=>{const el=document.getElementById(id);if(el){el.textContent=t;if(c)el.style.color=c;}};
  const k=v=>fmtK(Math.abs(v));
  let cumS=0,cumI=0,cumE=0,totI=0,totO=0,totS=0;

  perMonth.forEach((md,i)=>{
    const out=md.fixedExp+md.debtPmt+md.savings, surp=md.surplus;
    cumS+=surp; cumI+=md.income; cumE+=out; totI+=md.income; totO+=out; totS+=surp;
    s('fc-tbl-out-'+i, k(out), '#ff5b6b');
    s('fc-tbl-surp-'+i, (surp>=0?'+':'-')+k(surp), surp>=0?'#22d47e':'#ff5b6b');
    s('fc-tbl-cumul-'+i, (cumS>=0?'+':'-')+k(cumS), cumS>=0?'#22d47e':'#ff5b6b');
    s('fc-tbl-cuminc-'+i, k(cumI), '#22d47e');
    s('fc-tbl-cumexp-'+i, k(cumE), '#ff5b6b');
    const td=totalDebtData[i]||0;
    s('fc-tbl-totdebt-'+i, td<=0.01?'âœ“ Paid off':k(td), td<=0.01?'#22d47e':'#ff9f43');
  });

  s('fc-tbl-inc-tot', k(totI), '#22d47e');
  s('fc-tbl-out-tot', k(totO), '#ff5b6b');
  s('fc-tbl-surp-tot', (totS>=0?'+':'-')+k(totS), totS>=0?'#22d47e':'#ff5b6b');
  s('fc-tbl-cumul-tot', (cumS>=0?'+':'-')+k(cumS), cumS>=0?'#22d47e':'#ff5b6b');
  s('fc-tbl-cuminc-tot', k(cumI), '#22d47e');
  s('fc-tbl-cumexp-tot', k(cumE), '#ff5b6b');
  const fd=totalDebtData[MONTHS-1]||0;
  s('fc-tbl-totdebt-fin', fd<=0.01?'âœ“ Debt Free!':k(fd), fd<=0.01?'#22d47e':'#ff9f43');

  state.expenses.forEach(e=>{
    let t=0; for(let m=0;m<MONTHS;m++) t+=getPlannedExpenseAmount(e.id,m);
    s('fc-tbl-exp-tot-'+e.id, k(t), '#ff5b6b');
  });
  for(const [id,arr] of Object.entries(debtMonthlyData)){
    let tp=0,ti=0;
    arr.forEach((md,i)=>{
      tp+=md.payment; ti+=md.interest;
      s(`fc-tbl-bal-${id}-${i}`, md.balanceAfter<=0.01?'âœ“ Paid':k(md.balanceAfter), md.balanceAfter<=0.01?'#22d47e':'rgba(255,159,67,0.65)');
      s(`fc-tbl-int-${id}-${i}`, md.interest<0.005?'$0':k(md.interest), md.interest>50?'#ff9f43':'#6b7299');
    });
    s('fc-tbl-pmt-tot-'+id, k(tp), '#ff9f43');
    s('fc-tbl-int-tot-'+id, k(ti), '#ff9f43');
    const lb=arr[arr.length-1]?.balanceAfter||0;
    s('fc-tbl-bal-fin-'+id, lb<=0.01?'âœ“ Paid off':k(lb), lb<=0.01?'#22d47e':'rgba(255,159,67,0.65)');
  }
  state.goals.forEach(g=>{
    let t=0; for(let m=0;m<MONTHS;m++) t+=getPlannedGoalContrib(g.id,m);
    s('fc-tbl-goal-tot-'+g.id, k(t), '#38bdf8');
  });
  let gt=0; for(let m=0;m<MONTHS;m++) gt+=getPlannedGeneralSavings(m);
  s('fc-tbl-gensav-tot', k(gt), '#38bdf8');
}

function renderForecast() {
  fcMigrateState();
  if (!state.forecast.goalContributions) state.forecast.goalContributions = {};
  if (!state.forecast.generalSavings) state.forecast.generalSavings = 0;

  // Restore months selector
  const fcMonthsEl = document.getElementById('fcMonths');
  if (fcMonthsEl && state.forecast.forecastMonths) fcMonthsEl.value = state.forecast.forecastMonths;
  const MONTHS = parseInt(fcMonthsEl?.value) || 36;
  const now = new Date();
  const fcStart = new Date(now.getFullYear(), now.getMonth() + 1, 1);

  const includedDebts = state.debts.filter(d => d.included);

  // Initialize defaults for any debt/goal not yet set
  for (const d of includedDebts) {
    if (!state.forecast.debtPayments[d.id]) {
      state.forecast.debtPayments[d.id] = { default: d.minPayment, months: {} };
    }
  }
  for (const g of state.goals) {
    if (state.forecast.goalContributions[g.id] === undefined) state.forecast.goalContributions[g.id] = g.monthly || 0;
  }

  // Render master spreadsheet table
  const wrap = document.getElementById('fcMasterTableWrap');
  if (wrap) wrap.innerHTML = renderForecastTable(MONTHS, fcStart);

  // Run full calculation
  fcRefreshResults();
}


// â”€â”€â”€ CRUD HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
const debtColors = ['#5c7cff','#a78bfa','#22d47e','#ffd43b','#ff9f43','#ff5b6b','#38bdf8','#fb7185'];

function saveDebt() {
  const id = document.getElementById('editDebtId').value;
  const d = {
    id: id || uid(),
    name: document.getElementById('debtName').value.trim(),
    type: document.getElementById('debtType').value,
    balance: parseFloat(document.getElementById('debtBalance').value) || 0,
    apr: parseFloat(document.getElementById('debtAPR').value) || 0,
    minPayment: parseFloat(document.getElementById('debtMinPayment').value) || 0,
    limit: parseFloat(document.getElementById('debtLimit').value) || 0,
    dueDate: parseInt(document.getElementById('debtDueDate').value) || 1,
    notes: document.getElementById('debtNotes').value.trim(),
    included: true,
    color: debtColors[state.debts.length % debtColors.length]
  };
  if (!d.name) { toast('Please enter an account name', 'error'); return; }
  if (id) {
    const idx = state.debts.findIndex(x => x.id === id);
    d.included = state.debts[idx].included;
    d.color = state.debts[idx].color;
    state.debts[idx] = d;
  } else {
    state.debts.push(d);
  }
  closeModal('addDebtModal');
  saveToStorage();
  renderAll();
  toast(id ? 'Account updated!' : 'Account added!', 'success');
}

function editDebt(id) {
  const d = state.debts.find(x => x.id === id);
  document.getElementById('editDebtId').value = d.id;
  document.getElementById('debtModalTitle').textContent = 'Edit Account';
  document.getElementById('debtName').value = d.name;
  document.getElementById('debtType').value = d.type;
  document.getElementById('debtBalance').value = d.balance;
  document.getElementById('debtAPR').value = d.apr;
  document.getElementById('debtMinPayment').value = d.minPayment;
  document.getElementById('debtLimit').value = d.limit;
  document.getElementById('debtDueDate').value = d.dueDate;
  document.getElementById('debtNotes').value = d.notes || '';
  openModal('addDebtModal');
}

function deleteDebt(id) {
  if (!confirm('Remove this account?')) return;
  state.debts = state.debts.filter(x => x.id !== id);
  saveToStorage(); renderAll(); toast('Account removed', 'success');
}

function toggleDebt(id, val) {
  const d = state.debts.find(x => x.id === id);
  if (d) d.included = val;
  saveToStorage(); renderAll(); toast(val ? 'Included in calculations' : 'Excluded from calculations');
}

function quickUpdateBalance(id) {
  const d = state.debts.find(x => x.id === id);
  const newBal = prompt(`Update balance for ${d.name}:`, d.balance);
  if (newBal !== null) {
    const parsed = parseFloat(newBal);
    if (!isNaN(parsed)) {
      d.balance = parsed;
      saveToStorage(); renderAll(); toast('Balance updated!', 'success');
    }
  }
}

function saveIncome() {
  const id = document.getElementById('editIncomeId').value;
  const monthly = parseFloat(document.getElementById('incomeAmount').value) || 0;
  const freq = document.getElementById('incomeFrequency').value;
  // Store as entered amount per frequency
  let amount = monthly;
  if (freq === 'biweekly') amount = monthly;
  if (freq === 'annual') amount = monthly;
  const i = { id: id || uid(), name: document.getElementById('incomeName').value.trim(), amount, frequency: freq };
  if (!i.name) { toast('Enter income name', 'error'); return; }
  if (id) { const idx = state.income.findIndex(x => x.id === id); state.income[idx] = i; }
  else state.income.push(i);
  closeModal('incomeModal');
  saveToStorage(); renderAll(); toast('Income saved!', 'success');
}

function editIncome(id) {
  const i = state.income.find(x => x.id === id);
  document.getElementById('editIncomeId').value = i.id;
  document.getElementById('incomeName').value = i.name;
  document.getElementById('incomeAmount').value = i.amount;
  document.getElementById('incomeFrequency').value = i.frequency;
  openModal('incomeModal');
}
function deleteIncome(id) {
  if (!confirm('Remove this income?')) return;
  state.income = state.income.filter(x => x.id !== id);
  saveToStorage(); renderAll(); toast('Income removed');
}

function saveExpense() {
  const id = document.getElementById('editExpenseId').value;
  const e = { id: id || uid(), name: document.getElementById('expenseName').value.trim(), amount: parseFloat(document.getElementById('expenseAmount').value) || 0, category: document.getElementById('expenseCategory').value };
  if (!e.name) { toast('Enter expense name', 'error'); return; }
  if (id) { const idx = state.expenses.findIndex(x => x.id === id); state.expenses[idx] = e; }
  else state.expenses.push(e);
  closeModal('expenseModal');
  saveToStorage(); renderAll(); toast('Expense saved!', 'success');
}
function editExpense(id) {
  const e = state.expenses.find(x => x.id === id);
  document.getElementById('editExpenseId').value = e.id;
  document.getElementById('expenseName').value = e.name;
  document.getElementById('expenseAmount').value = e.amount;
  document.getElementById('expenseCategory').value = e.category;
  openModal('expenseModal');
}
function deleteExpense(id) {
  if (!confirm('Remove this expense?')) return;
  state.expenses = state.expenses.filter(x => x.id !== id);
  saveToStorage(); renderAll(); toast('Expense removed');
}

function saveGoal() {
  const id = document.getElementById('editGoalId').value;
  const g = { id: id || uid(), name: document.getElementById('goalName').value.trim(), emoji: document.getElementById('goalEmoji').value.trim() || 'ðŸŽ¯', target: parseFloat(document.getElementById('goalTarget').value) || 0, saved: parseFloat(document.getElementById('goalSaved').value) || 0, monthly: parseFloat(document.getElementById('goalMonthly').value) || 0 };
  if (!g.name) { toast('Enter goal name', 'error'); return; }
  if (id) { const idx = state.goals.findIndex(x => x.id === id); state.goals[idx] = g; }
  else state.goals.push(g);
  closeModal('addGoalModal');
  saveToStorage(); renderAll(); toast('Goal saved!', 'success');
}
function editGoal(id) {
  const g = state.goals.find(x => x.id === id);
  document.getElementById('editGoalId').value = g.id;
  document.getElementById('goalName').value = g.name;
  document.getElementById('goalEmoji').value = g.emoji || '';
  document.getElementById('goalTarget').value = g.target;
  document.getElementById('goalSaved').value = g.saved;
  document.getElementById('goalMonthly').value = g.monthly;
  openModal('addGoalModal');
}
function deleteGoal(id) {
  if (!confirm('Remove this goal?')) return;
  state.goals = state.goals.filter(x => x.id !== id);
  saveToStorage(); renderAll(); toast('Goal removed');
}

// â”€â”€â”€ MODAL & NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  // Reset hidden id fields
  ['editDebtId','editIncomeId','editExpenseId','editGoalId'].forEach(x => {
    const el = document.getElementById(x);
    if (el) el.value = '';
  });
  document.getElementById('debtModalTitle') && (document.getElementById('debtModalTitle').textContent = 'Add Account');
}
document.querySelectorAll('.modal-backdrop').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
});

let currentPage = 'dashboard';
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll(`[onclick="showPage('${page}')"]`).forEach(el => el.classList.add('active'));
  currentPage = page;
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.remove('open');
  }
  if (page === 'dashboard') renderDashboard();
  else if (page === 'cashflow') renderCashFlow();
  else if (page === 'debts') renderDebts();
  else if (page === 'payoff') renderPayoff();
  else if (page === 'goals') renderGoals();
  else if (page === 'forecast') renderForecast();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function toast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveToStorage() {
  try { localStorage.setItem('finflow', JSON.stringify(state)); } catch(e) {}
}

function loadFromStorage() {
  try {
    const saved = localStorage.getItem('finflow');
    if (saved) {
      const parsed = JSON.parse(saved);
      state = { ...state, ...parsed };
      return true;
    }
  } catch(e) {}
  return false;
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'finflow-data-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Data exported!', 'success');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      state = { ...state, ...data };
      saveToStorage();
      renderAll();
      toast('Data imported!', 'success');
    } catch {
      toast('Invalid file format', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function renderAll() {
  const page = currentPage;
  if (page === 'dashboard') renderDashboard();
  else if (page === 'cashflow') renderCashFlow();
  else if (page === 'debts') renderDebts();
  else if (page === 'payoff') renderPayoff();
  else if (page === 'goals') renderGoals();
  else if (page === 'forecast') renderForecast();
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  const loaded = loadFromStorage();
  if (!loaded) loadDefaults();
  renderDashboard();
})();
</script>

</body>
</html>
